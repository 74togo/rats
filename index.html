<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Island Rats Character Manager</title>
    <style>
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { text-align: center; color: #e94560; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        h2 { color: #0f3460; background: #e94560; padding: 10px; border-radius: 5px; margin: 15px 0 10px; }
        h3 { color: #e94560; margin: 10px 0; border-bottom: 1px solid #e94560; padding-bottom: 5px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab { padding: 10px 20px; background: #16213e; border: none; color: #eee; cursor: pointer; border-radius: 5px 5px 0 0; transition: all 0.3s; }
        .tab:hover, .tab.active { background: #e94560; }
        .panel { display: none; background: #16213e; padding: 20px; border-radius: 0 5px 5px 5px; }
        .panel.active { display: block; }
        .stat-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin: 10px 0; }
        .stat-box { background: #0f3460; padding: 15px; border-radius: 5px; text-align: center; }
        .stat-box label { display: block; font-size: 12px; color: #aaa; margin-bottom: 5px; }
        .stat-box .value { font-size: 24px; font-weight: bold; color: #e94560; }
        input, select, button, textarea { padding: 10px; border: none; border-radius: 5px; font-size: 14px; }
        input, select, textarea { background: #0f3460; color: #eee; width: 100%; margin: 5px 0; }
        button { background: #e94560; color: #fff; cursor: pointer; transition: all 0.3s; margin: 5px 2px; }
        button:hover { background: #ff6b6b; transform: translateY(-2px); }
        .btn-small { padding: 5px 10px; font-size: 12px; }
        .btn-danger { background: #c23616; }
        .btn-success { background: #44bd32; }
        .row { display: flex; gap: 10px; align-items: center; margin: 10px 0; flex-wrap: wrap; }
        .col { flex: 1; min-width: 200px; }
        .item-list { background: #0f3460; padding: 10px; border-radius: 5px; margin: 10px 0; max-height: 400px; overflow-y: auto; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #1a1a2e; }
        .item:last-child { border-bottom: none; }
        .spell-card { background: #0f3460; padding: 15px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #e94560; }
        .spell-card h4 { color: #e94560; margin-bottom: 10px; }
        .roll-result { background: #0f3460; padding: 20px; border-radius: 5px; text-align: center; margin: 15px 0; }
        .roll-result .dice { font-size: 36px; color: #e94560; }
        .roll-result .total { font-size: 24px; margin-top: 10px; }
        .success { color: #44bd32; }
        .failure { color: #c23616; }
        .combat-log { background: #0f3460; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto; font-family: monospace; }
        .log-entry { padding: 5px; border-bottom: 1px solid #1a1a2e; }
        .health-bar { background: #333; border-radius: 10px; height: 30px; overflow: hidden; margin: 10px 0; }
        .health-fill { background: linear-gradient(90deg, #c23616, #e94560); height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; font-weight: bold; padding-left: 2em; }
        .section { margin: 15px 0; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { padding: 8px; text-align: left; border-bottom: 1px solid #0f3460; }
        th { background: #0f3460; }
        .highlight { color: #e94560; font-weight: bold; }
        .flex-wrap { display: flex; flex-wrap: wrap; gap: 5px; }
	/* Dialog Overlay */
.dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.dialog {
    background: #2a2a2a;
    padding: 20px;
    border-radius: 8px;
    max-width: 500px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
    border: 2px solid #4a4a4a;
}

.dialog h3 {
    margin-top: 0;
    color: #ffd700;
}

.dialog label {
    display: block;
    margin-top: 10px;
    font-weight: bold;
}

.dialog select,
.dialog input,
.dialog textarea {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    background: #1a1a1a;
    border: 1px solid #4a4a4a;
    color: #fff;
    border-radius: 4px;
}

.dialog textarea {
    min-height: 80px;
}

.dialog-buttons {
    margin-top: 20px;
    display: flex;
    gap: 10px;
    justify-content: flex-end;
}

/* Feature Selection Panel */
.feature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 10px;
}

.feature-option {
    background: #1a1a1a;
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #4a4a4a;
}

.feature-option.owned {
    border-color: #4CAF50;
    background: #1a2a1a;
}

.feature-option.disabled {
    opacity: 0.5;
}

.feature-option strong {
    color: #ffd700;
}

.feature-option p {
    font-size: 0.9em;
    margin: 5px 0;
}

.badge {
    display: inline-block;
    padding: 2px 8px;
    background: #4a4a4a;
    border-radius: 4px;
    font-size: 0.8em;
}

.feature-option.owned .badge {
    background: #4CAF50;
}

/* Miracle Display */
.prayers-display {
    background: #1a1a1a;
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 10px;
}

.domain-display {
    color: #ffd700;
    margin-bottom: 10px;
}

.miracle {
    border-left: 3px solid #ffd700;
    padding-left: 10px;
}

.miracle.custom {
    border-left-color: #9c27b0;
}

/* Signature Weapon */
.signature-weapon {
    background: linear-gradient(90deg, #2a1a1a, #1a1a1a);
    border-left: 3px solid #ff5722;
}

/* Path Descriptions */
.path-descriptions {
    margin-top: 10px;
    font-size: 0.9em;
    background: #1a1a1a;
    padding: 10px;
    border-radius: 6px;
}

.path-descriptions p {
    margin: 5px 0;
}

/* Spell List in Dialogs */
.spell-list {
    max-height: 200px;
    overflow-y: auto;
    margin: 10px 0;
}
    </style>
</head>
<body>
    <div class="container">
        <h1>‚öîÔ∏è Island Rats ‚öîÔ∏è</h1>
        
        <div class="tabs">
            <button class="tab active" onclick="showTab('character')">Character Sheet</button>
            <button class="tab" onclick="showTab('creation')">Create Character</button>
            <button class="tab" onclick="showTab('spells')">Spells</button>
            <button class="tab" onclick="showTab('combat')">Combat</button>
            <button class="tab" onclick="showTab('dice')">Dice Roller</button>
            <button class="tab" onclick="showTab('exploration')">Exploration</button>
        </div>

        <!-- CHARACTER SHEET PANEL -->
        <div id="character" class="panel active">
            <div class="row">
                <div class="col">
                    <div class="stat-box">
                        <label>NAME</label>
                        <div class="value" id="display-name">-</div>
                    </div>
                </div>
                <div class="col">
                    <div class="stat-box">
                        <label>LEVEL</label>
                        <div class="value" id="display-level">1</div>
                    </div>
                </div>
                <div class="col">
                    <div class="stat-box">
                        <label>XP</label>
                        <div class="value" id="display-xp">0</div>
                    </div>
                </div>
                <div class="col">
                    <div class="stat-box">
                        <label>ARCHETYPE</label>
                        <div class="value" id="display-archetype" style="font-size:16px;">-</div>
                    </div>
                </div>
            </div>

            <h3>Health</h3>
            <div class="health-bar">
                <div class="health-fill" id="health-bar-fill" style="width: 100%;">
                    <span id="health-display">6/6</span>
                </div>
            </div>
            <div class="row">
                <button onclick="modifyHealth(-1)" class="btn-danger">-1 HP</button>
                <button onclick="modifyHealth(1)" class="btn-success">+1 HP</button>
                <button onclick="fullHeal()" class="btn-success">Rest (Full Heal)</button>
                <button onclick="useMedicine()">Use Medicine (+1 HP)</button>
            </div>

            <div class="stat-grid">
                <div class="stat-box">
                    <label>STRENGTH</label>
                    <div class="value" id="display-str">+0</div>
                </div>
                <div class="stat-box">
                    <label>DEXTERITY</label>
                    <div class="value" id="display-dex">+0</div>
                </div>
                <div class="stat-box">
                    <label>WILL</label>
                    <div class="value" id="display-wil">+0</div>
                </div>
                <div class="stat-box">
                    <label>ARMOR</label>
                    <div class="value" id="display-armor">6</div>
                </div>
            </div>

            <h3>Miracles</h3>
            <div class="item-list" id="miracles-list"></div>

            <h3>Weapons & Equipment</h3>
            <div class="item-list" id="weapons-list"></div>

            <h3>Inventory (Belt & Backpack)</h3>
            <div class="row">
                <input type="text" id="new-item" placeholder="Add new item...">
                <select id="item-location">
                    <option value="belt">Belt</option>
                    <option value="backpack">Backpack</option>
                    <option value="hands">Hands</option>
                    <option value="worn">Worn</option>
                </select>
                <button onclick="addItem()">Add</button>
            </div>
            <div class="item-list" id="inventory-list"></div>

            <h3>Features & Abilities</h3>
            <div class="item-list" id="features-list"></div>

	    <h3>Feature Selection Panel</h3>
	    <div class="section" id="feature-selection-panel"></div>

            <h3>Character Details</h3>
            <div class="section">
                <p><strong>Goal:</strong> <span id="display-goal">-</span></p>
                <p><strong>Relationship:</strong> <span id="display-relationship">-</span></p>
                <p><strong>Background:</strong> <span id="display-background">-</span></p>
            </div>

            <h3>Scars</h3>
            <div class="item-list" id="scars-list"></div>

            <div class="row" style="margin-top: 20px;">
                <button onclick="addXP(1)" class="btn-success">+1 XP</button>
                <button onclick="checkLevelUp()">Check Level Up</button>
                <button onclick="saveCharacter()" class="btn-success">üíæ Save Character</button>
                <button onclick="exportCharacter()">üì§ Export</button>
                <button onclick="deleteCharacter()" class="btn-danger">üóëÔ∏è Delete Character</button>
            </div>
        </div>

        <!-- CHARACTER CREATION PANEL -->
        <div id="creation" class="panel">
            <h3>1. Name</h3>
            <div class="row">
                <input type="text" id="char-name" placeholder="Enter character name">
                <button onclick="randomName('male')">Random Male</button>
                <button onclick="randomName('female')">Random Female</button>
            </div>

            <h3>2. Abilities</h3>
            <div class="row">
                <button onclick="rollAbilities()">üé≤ Roll Abilities</button>
            </div>
            <div class="stat-grid">
                <div class="stat-box">
                    <label>STRENGTH</label>
                    <input type="number" id="create-str" value="0" min="-2" max="4">
                </div>
                <div class="stat-box">
                    <label>DEXTERITY</label>
                    <input type="number" id="create-dex" value="0" min="-2" max="4">
                </div>
                <div class="stat-box">
                    <label>WILL</label>
                    <input type="number" id="create-wil" value="0" min="-2" max="4">
                </div>
            </div>

            <h3>3. Archetype</h3>
            <select autocomplete="off" id="create-archetype" onchange="updateArchetypeOptions()">
                <option value="" selected>Select Archetype...</option>
                <option value="mage">Mage</option>
                <option value="disciple">Disciple</option>
                <option value="vagabond">Vagabond</option>
            </select>
            
            <div id="archetype-options" class="section" style="display:none;"></div>

            <h3>4. Weapon Package</h3>
            <div class="row">
                <select id="create-weapons">
                    <option value="0">Light armor, shield, light weapon, ranged</option>
                    <option value="1">Heavy armor, heavy weapon</option>
                </select>
                <button onclick="randomWeaponPackage()">üé≤ Random</button>
            </div>

            <h3>5. Tools (Pick 2)</h3>
            <div class="row">
                <select id="create-tool1">
                    <option value="Rope (50 ft.)">Rope (50 ft.)</option>
                    <option value="Torches (3)">Torches (3)</option>
                </select>
                <select id="create-tool2">
                    <option value="Rope (50 ft.)">Rope (50 ft.)</option>
                    <option value="Torches (3)">Torches (3)</option>
                </select>
                <button onclick="randomTools()">üé≤ Random</button>
            </div>

            <h3>6. Items (Pick 2)</h3>
            <div class="row">
                <select id="create-item1">
                    <option value="Lantern">Lantern</option>
                    <option value="Waterskin">Waterskin</option>
                </select>
                <select id="create-item2">
                    <option value="Lantern">Lantern</option>
                    <option value="Waterskin">Waterskin</option>
                </select>
                <button onclick="randomItems()">üé≤ Random</button>
            </div>

            <h3>7. Goal</h3>
            <div class="row">
                <select id="create-goal">
                    <option value="Wealth">Wealth</option>
                    <option value="Revenge">Revenge</option>
                </select>
                <button onclick="randomGoal()">üé≤ Random</button>
            </div>

            <h3>8. Relationship</h3>
            <div class="row">
                <select id="create-relationship">
                    <option value="Rival">Rival</option>
                    <option value="Mentor">Mentor</option>
                </select>
                <button onclick="randomRelationship()">üé≤ Random</button>
            </div>

            <h3>9. Background</h3>
            <div class="row">
                <select id="create-background">
                    <option value="Corner Beggar">Corner Beggar (street contacts, thieves' cant)</option>
                    <option value="Mercenary">Mercenary (bloodoath coin, burden of souls)</option>
                </select>
                <button onclick="randomBackground()">üé≤ Random</button>
            </div>

            <div class="section" style="margin-top: 20px;">
                <button onclick="createCharacter()" class="btn-success" style="width:100%; padding:15px; font-size:18px;">
                    ‚ú® Create Character ‚ú®
                </button>
            </div>
        </div>

        <!-- SPELLS PANEL -->
        <div id="spells" class="panel">
            <h3>Spell Generator</h3>
            <div class="row">
                <button onclick="generateSpell()">üé≤ Generate Random Spell</button>
                <button onclick="generateSpellFromTable()">üìñ Roll from 108 Spells</button>
            </div>
            
            <div id="generated-spell" class="spell-card" style="display:none;"></div>

            <h3>Mage Resources</h3>
            <div class="stat-grid">
                <div class="stat-box">
                    <label>ESSENCE</label>
                    <div class="row">
                        <button class="btn-small" onclick="modifyEssence(-1)">-</button>
                        <span class="value" id="display-essence">0</span>
                        <button class="btn-small" onclick="modifyEssence(1)">+</button>
                    </div>
                </div>
                <div class="stat-box">
                    <label>MAX ESSENCE</label>
                    <div class="value" id="display-max-essence">2</div>
                </div>
            </div>

            <h3>Memorized Spells</h3>
            <div class="row">
                <button onclick="conductRitual()">üîÆ Conduct Ritual (Roll New Spells)</button>
            </div>
            <div id="memorized-spells" class="item-list"></div>

            <h3>Quintessence</h3>
            <div class="item-list" id="quintessence-list"></div>

            <h3>Spell Components Reference</h3>
            <div class="row">
                <button onclick="rollComponent('effect')">Roll Effect</button>
                <button onclick="rollComponent('element')">Roll Element</button>
                <button onclick="rollComponent('form')">Roll Form</button>
            </div>
            <div id="component-result" class="roll-result" style="display:none;"></div>
        </div>

        <!-- COMBAT PANEL -->
        <div id="combat" class="panel">
            <h3>Attack Calculator</h3>
            <div class="section">
                <div class="row">
                    <div class="col">
                        <label>Weapon Type:</label>
                        <select id="weapon-type">
                            <option value="-1">Unarmed (-1 AB)</option>
                            <option value="1">Light Weapon (+1 AB)</option>
                            <option value="2">Heavy Weapon (+2 AB)</option>
                            <option value="0">Ranged Weapon (+0 AB)</option>
                        </select>
                    </div>
                    <div class="col">
                        <label>Target Armor:</label>
                        <input type="number" id="target-armor" value="6" min="0">
                    </div>
                </div>
                <div class="row">
                    <label><input type="checkbox" id="has-advantage"> Has Advantage</label>
                </div>
                <button onclick="rollAttack()" style="width:100%; padding:15px;">‚öîÔ∏è Roll Attack</button>
            </div>
            
            <div id="attack-result" class="roll-result" style="display:none;"></div>

            <h3>Defend Against Attack</h3>
            <div class="section">
                <div class="row">
                    <div class="col">
                        <label>Incoming Attack Total:</label>
                        <input type="number" id="incoming-attack" value="8" min="0">
                    </div>
                </div>
                <button onclick="calculateDamage()" style="width:100%;">üõ°Ô∏è Calculate Damage Taken</button>
            </div>
            <div id="damage-result" class="roll-result" style="display:none;"></div>

            <h3>Initiative Roll</h3>
            <button onclick="rollInitiative()">üèÉ Roll DEX Danger Roll</button>
            <div id="initiative-result" class="roll-result" style="display:none;"></div>

            <h3>Dying Roll (At ‚â§0 HP)</h3>
            <button onclick="rollScar()" class="btn-danger">üíÄ Dying Roll</button>
            <div id="scar-result" class="roll-result" style="display:none;"></div>

            <h3>Combat Log</h3>
            <div class="combat-log" id="combat-log"></div>
            <button onclick="clearCombatLog()" class="btn-small">Clear Log</button>
        </div>

        <!-- DICE ROLLER PANEL -->
        <div id="dice" class="panel">
            <h3>Quick Rolls</h3>
            <div class="flex-wrap">
                <button onclick="quickRoll(1, 6)">1d6</button>
                <button onclick="quickRoll(2, 6)">2d6</button>
                <button onclick="quickRoll(3, 6)">3d6</button>
                <button onclick="quickRoll(1, 20)">1d20</button>
            </div>

            <h3>Danger Roll</h3>
            <div class="section">
                <div class="row">
                    <div class="col">
                        <label>Ability:</label>
                        <select id="danger-ability">
                            <option value="str">Strength</option>
                            <option value="dex">Dexterity</option>
                            <option value="wil">Will</option>
                        </select>
                    </div>
                    <div class="col">
                        <label><input type="checkbox" id="danger-advantage"> Advantage (3d keep 2)</label>
                    </div>
                </div>
                <button onclick="rollDanger()" style="width:100%;">üé≤ Roll Danger</button>
            </div>
            <div id="danger-result" class="roll-result" style="display:none;"></div>

            <h3>Opposed Roll</h3>
            <div class="section">
                <div class="row">
                    <div class="col">
                        <label>Your Ability Bonus:</label>
                        <input type="number" id="opposed-your-bonus" value="0">
                    </div>
                    <div class="col">
                        <label>Opponent's Ability Bonus:</label>
                        <input type="number" id="opposed-opp-bonus" value="0">
                    </div>
                </div>
                <button onclick="rollOpposed()" style="width:100%;">‚öîÔ∏è Roll Opposed</button>
            </div>
            <div id="opposed-result" class="roll-result" style="display:none;"></div>

            <h3>Barter Roll</h3>
            <div class="section">
                <div class="row">
                    <div class="col">
                        <label>Staked Item Quality:</label>
                        <input type="number" id="barter-quality" value="1" min="0" max="7">
                    </div>
                </div>
                <button onclick="rollBarter()" style="width:100%;">üí∞ Roll Barter</button>
            </div>
            <div id="barter-result" class="roll-result" style="display:none;"></div>

            <h3>Roll History</h3>
            <div class="item-list" id="roll-history"></div>
            <button onclick="clearRollHistory()" class="btn-small">Clear History</button>
        </div>

        <!-- EXPLORATION PANEL -->
        <div id="exploration" class="panel">
            <h3>Hazard Roll</h3>
            <p>Roll when PCs spend time or do something that might attract attention.</p>
            <button onclick="rollHazard()" style="width:100%; padding:15px;">üé≤ Roll Hazard (1d6)</button>
            <div id="hazard-result" class="roll-result" style="display:none;"></div>

            <h3>Morale Check</h3>
            <div class="section">
                <div class="row">
                    <div class="col">
                        <label>NPC Will Bonus:</label>
                        <input type="number" id="morale-wil" value="0">
                    </div>
                </div>
                <button onclick="rollMorale()">üíî Roll Morale</button>
            </div>
            <div id="morale-result" class="roll-result" style="display:none;"></div>

            <h3>XP Checklist</h3>
            <div class="section">
                <p>Answer at end of session (1 XP each "yes"):</p>
                <label><input type="checkbox" class="xp-check"> Did I explore somewhere new?</label><br>
                <label><input type="checkbox" class="xp-check"> Did we complete a contract?</label><br>
                <label><input type="checkbox" class="xp-check"> Did we overcome a notable foe?</label><br>
                <label><input type="checkbox" class="xp-check"> Did we change the world?</label><br>
                <label><input type="checkbox" class="xp-check"> Did we work together as a party?</label><br>
                <button onclick="awardSessionXP()" class="btn-success" style="margin-top:10px;">Award XP</button>
            </div>

            <h3>Level Progression</h3>
            <table>
                <tr><th>Level</th><th>XP Required</th><th>Rank</th><th>Gain</th></tr>
                <tr><td>1</td><td>0</td><td>Porcelain</td><td>-</td></tr>
                <tr><td>2</td><td>2</td><td>Copper</td><td>+1 Ability</td></tr>
                <tr><td>3</td><td>6</td><td>Silver</td><td>+1 Feature</td></tr>
                <tr><td>4</td><td>12</td><td>Gold</td><td>+1 Ability</td></tr>
                <tr><td>5</td><td>20</td><td>Platinum</td><td>+1 Feature</td></tr>
            </table>

            <h3>Quality Reference</h3>
            <table>
                <tr><th>Quality</th><th>Examples</th></tr>
                <tr><td>0</td><td>Common item, light weapon, single coin</td></tr>
                <tr><td>1</td><td>Specialty item, ranged weapon, shield</td></tr>
                <tr><td>2</td><td>Light armor, heavy weapon, potion</td></tr>
                <tr><td>3</td><td>Heavy armor, small magic item</td></tr>
            </table>
        </div>
    </div>

    <script>
        // ============ DATA TABLES ============

const TABLES = {
    abilities: [
        { str: 2, dex: 1, wil: 0 },
        { str: 2, dex: 0, wil: 1 },
        { str: 1, dex: 2, wil: 0 },
        { str: 0, dex: 2, wil: 1 },
        { str: 1, dex: 0, wil: 2 },
        { str: 0, dex: 1, wil: 2 }
    ],
    
    weaponPackages: [
        { name: "Light armor, shield, light weapon, ranged weapon", armor: 7, items: ["Light Armor (worn)", "Shield (+1 armor)", "Light Weapon (+1 AB)", "Ranged Weapon (+0 AB)"] },
        { name: "Light armor, shield, light weapon, ranged weapon", armor: 7, items: ["Light Armor (worn)", "Shield (+1 armor)", "Light Weapon (+1 AB)", "Ranged Weapon (+0 AB)"] },
        { name: "Light armor, light weapon, heavy weapon", armor: 7, items: ["Light Armor (worn)", "Light Weapon (+1 AB)", "Heavy Weapon (+2 AB)"] },
        { name: "Light armor, heavy weapon, ranged weapon", armor: 7, items: ["Light Armor (worn)", "Heavy Weapon (+2 AB)", "Ranged Weapon (+0 AB)"] },
        { name: "Heavy armor, light weapon, ranged weapon", armor: 8, items: ["Heavy Armor (worn)", "Light Weapon (+1 AB)", "Ranged Weapon (+0 AB)"] },
        { name: "Heavy armor, heavy weapon", armor: 8, items: ["Heavy Armor (worn)", "Heavy Weapon (+2 AB)"] }
    ],
    
    tools: [
        "Animal scent", "Bear trap", "Bedroll", "Caltrops", "Chain (10 ft.)", "Chalk",
        "Iron tongs", "Lantern and oil", "Large sack", "Lockpicks (3)", "Manacles", "Medicine (3)",
        "Chisel", "Grease", "Crowbar", "Hacksaw", "Fishing net", "Hammer",
        "Glass marbles", "Hand drill", "Glue", "Horn", "Grappling hook", "Iron spikes",
        "Metal file", "Rations (3)", "Rope (50 ft.)", "Steel wire", "Shovel", "Steel mirror",
        "Ten foot pole", "Tinderbox", "Torches (3)", "Vial of acid", "Vial of poison", "Waterskin"
    ],
    
    items: [
        "Book", "Bottle", "Bucket", "Candles (5)", "Card deck", "Chicken",
        "Cow", "Dice set", "Face paint", "Fake jewels", "Fishing rod", "Ham",
        "Horn", "Hourglass", "Incense", "Instrument", "Keg", "Lens",
        "Marbles", "Metal file", "Mirror", "Mystery egg", "Nails", "Perfume",
        "Pick", "Pig", "Pipe", "Saw", "Skull", "Small bell",
        "Soap", "Sponge", "Spyglass", "Tongs", "Waterskin", "Whistle"
    ],
    
    goals: [
        "A better life", "Enlightenment", "Acceptance", "Fame", "Acquire item", "Found faction",
        "Craft item", "Freedom", "Destroy faction", "Glory", "Destroy item", "Impress NPC",
        "Locate NPC", "Love", "Mastery", "Power", "Reach location", "Rescue NPC",
        "Infamy", "Infiltrate faction", "Justice", "Kidnap NPC", "Lead faction", "Learning",
        "Resolve dispute", "Serve evil", "Restore faction", "Serve faction", "Reveal a secret", "Serve ideology",
        "Revenge", "Serve leader", "Sabotage faction", "Serve the needy", "Serve a deity", "Wealth"
    ],
    
    relationships: [
        "Adviser", "Client", "Blackmailer", "Confidant", "Business partner", "Debtor",
        "Business rival", "Disciple", "Buyer", "Guardian", "Captor", "Henchman",
        "Idiot twin", "Informant", "Master", "Mentor", "Nemesis", "Offspring",
        "Parent", "Patron", "Political rival", "Prisoner", "Prot√©g√©", "Quarry",
        "Stalker", "Suitor", "Supplicant", "Supplier", "Sweetheart", "Unrequited love",
        "Right hand", "Romantic rival", "Servant", "Sibling", "Social rival", "Spouse"
    ],
    
    backgrounds: [
        { name: "Corner Beggar", items: ["street contacts", "thieves' cant"] },
        { name: "Hypnotist", items: ["silver charm", "melodic voice"] },
        { name: "Secret Initiate", items: ["holy water vial", "alabaster symbol"] },
        { name: "Champion", items: ["coveted prize", "lover's token"] },
        { name: "Hollow Jailer", items: ["buddies' flagon", "disease-immune"] },
        { name: "Folk Hero", items: ["estate deed", "tokens of favor"] },
        { name: "Inept Painter", items: ["forged art", "glowing chalk"] },
        { name: "Fisherman", items: ["tall tale net", "old willow rod"] },
        { name: "Forsaken Boatman", items: ["mossy rowing boat", "shell of lost voices"] },
        { name: "Fortune Teller", items: ["unfinished tarot", "rabid rat's foot"] },
        { name: "Wanted Gambler", items: ["loaded dice", "serrated card (+0)"] },
        { name: "Royal Guard", items: ["rusted banner", "princess' locket"] },
        { name: "Herdsman", items: ["goddess flute", "sling (+0)"] },
        { name: "Ember Alchemist", items: ["smoke flask", "bag of desert wind"] },
        { name: "Monster Hunter", items: ["dragon heart", "dowsing claw"] },
        { name: "Old Sea Wolf", items: ["lost hand or leg", "pirate flag"] },
        { name: "Town Agitator", items: ["pamphlets", "dog whistle"] },
        { name: "Road Warden", items: ["spirit's true name", "family horse"] },
        { name: "Game Keeper", items: ["man trap", "oak pet whistle"] },
        { name: "Grave Robber", items: ["spade of bones", "forgotten will"] },
        { name: "Counterfeiter", items: ["fake coins (100)", "forged certificate"] },
        { name: "City Watch", items: ["spectre lantern", "pierce shield (+1)"] },
        { name: "Failed Inventor", items: ["returning wrench", "sky-warped gear"] },
        { name: "Decay Seer", items: ["cracked bones", "afterworld eyewear"] },
        { name: "Ex-Slaver", items: ["rescued slave", "whip (+1)"] },
        { name: "Burglar", items: ["monster's egg", "keyless lock"] },
        { name: "Templar", items: ["etched promise", "full armor"] },
        { name: "Herbalist", items: ["seed collection", "fae companion"] },
        { name: "Troll Slayer", items: ["regeneration", "animal scent"] },
        { name: "Forester", items: ["faerie tinder", "bloodsap axe (+2)"] },
        { name: "Sea Captain", items: ["black spot", "phoenix feather"] },
        { name: "Gang Leader", items: ["unreliable mooks", "bad reputation"] },
        { name: "Footsoldier", items: ["traitor's mark", "heavy noose"] },
        { name: "Rat Catcher", items: ["ten-foot pole", "bag of tricks"] },
        { name: "Tattoo Artist", items: ["read runes", "inking tools"] },
        { name: "Bounty Hunter", items: ["expired contract", "poison"] },
        { name: "Mercenary", items: ["bloodoath coin", "burden of souls"] },
        { name: "Prospector", items: ["map to riches", "bombs (4)"] },
        { name: "Troubadour", items: ["stolen lute", "magic music box"] },
        { name: "Vengeful Hermit", items: ["pet vermin", "hate list"] },
        { name: "Exiled Monarch", items: ["bodyguard", "pet eagle"] },
        { name: "Demigod", items: ["divine talent", "nectar of the gods"] },
        { name: "Witch Hunter", items: ["hex-catcher", "engraved pistol (+1)"] },
        { name: "Pixie Catcher", items: ["gremlin jar", "appearance dust"] },
        { name: "Pit Fighter", items: ["rival's tooth", "brass knuckles (+1)"] },
        { name: "Physician", items: ["serpent's tears", "poison, ether"] },
        { name: "Hound Breeder", items: ["pet hound", "mind link"] },
        { name: "Loxodon", items: ["eternal memory", "radiant staff"] },
        { name: "Lost Legionnaire", items: ["ancient horn", "last orders"] },
        { name: "Parcel Knight", items: ["introduction letter", "tower shield (+2)"] },
        { name: "Rustler", items: ["stolen stock", "exotic mount"] },
        { name: "Knife Thrower", items: ["unflattering cut", "balanced blades"] },
        { name: "Outlander", items: ["obscuring hood", "lost culture"] },
        { name: "Gnome", items: ["darkvision", "wand of illusion"] },
        { name: "Coachman", items: ["hardy pony", "blunderbuss (+1)"] },
        { name: "Hedge Knight", items: ["official signet", "steadfast squire"] },
        { name: "Fire Eater", items: ["spinning torch (+1)", "trick manacles"] },
        { name: "Foreign Slave", items: ["skeleton key", "alien culture"] },
        { name: "Party Animal", items: ["raised by wolves", "party tricks"] },
        { name: "Fae-touched", items: ["invisible powder", "dazzling lights"] },
        { name: "Star Lawyer", items: ["gown with wig", "book of law"] },
        { name: "Assassin", items: ["guild reptile", "blowgun (+0)"] },
        { name: "Convicted Noble", items: ["lover's ring", "faithful follower"] },
        { name: "Family Artisan", items: ["trade tools", "work hut"] },
        { name: "Stargazer", items: ["telescope", "astronomy"] },
        { name: "Elemental", items: ["natural infusion", "mute"] },
        { name: "Grizzled Lawman", items: ["royal credentials", "lasso"] },
        { name: "Targeteer", items: ["elven longbow (+1)", "lucky arrow"] },
        { name: "Stage Actor", items: ["dramatic fame", "wigged disguise"] },
        { name: "Cursed One", items: ["weighted stone", "bane claymore (+2)"] },
        { name: "Angelic Offspring", items: ["feather wings", "lay on hands"] },
        { name: "Infernal", items: ["telltale sign", "dealbinding scroll"] }
    ],
    
    maleNames: [
        "Balthazar", "Basil", "Bertram", "Blaxton", "Chadwick", "Clovis",
        "Destrian", "Ellis", "Erasmus", "Faustus", "Finn", "Fitzhugh",
        "Florian", "Fox", "Godwin", "Hannibal", "Jasper", "Jiles",
        "Jules", "Leopold", "Merrick", "Mortimer", "Ogden", "Orion",
        "Oswald", "Percival", "Peregrine", "Quentin", "Redmaine", "Reinhold",
        "Silas", "Stilton", "Stratford", "Tenpiece", "Waverly", "Webster"
    ],
    
    femaleNames: [
        "Adelaide", "Alma", "Barsaba", "Beatrix", "Bianca", "Cleopha",
        "Clover", "Constance", "Damaris", "Daphne", "Demona", "Elsbeth",
        "Esme", "Fern", "Hester", "Hippolyta", "Jessamine", "Jilly",
        "Morgot", "Minerva", "Nerissa", "Odette", "Olga", "Orchid",
        "Pepper", "Phoebe", "Piety", "Poppy", "Silence", "Sybil",
        "Trillby", "Tuesday", "Ursula", "Vivian", "Wendy", "Zora"
    ],
    
    lowerSurnames: [
        "Barrow", "Beetleman", "Berrycloth", "Birdwhistle", "Borrin", "Chips",
        "Coffin", "Crumpling", "Culpepper", "Dankworth", "Digworthy", "Dreggs",
        "Gimble", "Graveworm", "Greelish", "Hardwick", "Hatman", "Hovel",
        "Knibbs", "Midnighter", "Needle", "Nethercoat", "Pestle", "Relish",
        "Rumbold", "Rummage", "Sallow", "Saltmarsh", "Silverless", "Skitter",
        "Slee", "Slitherly", "Stoker", "Tarwater", "Tumbler", "Villin"
    ],
    
    upperSurnames: [
        "Belvedere", "Bithesea", "Calaver", "Carvolo", "De Rippe", "Droll",
        "Dunlow", "Edevane", "Erelong", "Febland", "Fernsby", "Fisk",
        "Gastrell", "Girdwood", "Gorgon", "Grimeson", "Gruger", "Hitheryon",
        "La Marque", "Malmora", "Miter", "Oblington", "Onymous", "Phillifent",
        "Portendorfer", "Romatet", "Rothery", "Skorbeck", "Slora", "Southwark",
        "Stavish", "Vandermeer", "Wellbelove", "Westergren", "Wexley", "Wilberforce"
    ],
    
    implements: [
        "Amulet", "Anklet", "Bandana", "Book", "Boots", "Bracelet",
        "Broach", "Circlet", "Cloak", "Crown", "Earring", "Fake eye",
        "Gloves", "Goggles", "Hat", "Ingot", "Locket", "Mask",
        "Necklace", "Orb", "Phylactery", "Pipe", "Ring", "Rod",
        "Scarf", "Scroll", "Spectacles", "Staff", "Symbol", "Tattoo",
        "Tie", "Totem", "Valu. Material", "Veil", "Vest", "Wand"
    ],
    
    domains: [
        "Animal", "Balance", "Book", "Chance", "Chaos", "Circles",
        "Conquest", "Death", "Destiny", "Dreams", "Element", "Form",
        "Gateway", "Judgement", "Light", "Knowledge", "Monster", "Moon",
        "Music", "NPC", "Oaths", "Order", "Plague", "Purification",
        "Protection", "Secrets", "Storms", "Summer", "Sun", "The Forge",
        "The Sea", "Time", "Underworld", "Wealth", "Wilderness", "Winter"
    ],
    
    vagabondWeapons: [
        "Blowgun", "Boomerang", "Cane sword", "Cat claw", "Chakram", "Claymore",
        "Cleaver", "Club", "Crossbow", "Cutlass", "Dagger", "Flail",
        "Gauntlet", "Greataxe", "Halberd", "Hammer", "Hand crossbow", "Hatchet",
        "Javelin", "Longbow", "Longsword", "Mace", "Machete", "Maul",
        "Morningstar", "Pistol", "Shield", "Shortsword", "Shovel", "Sickle",
        "Sling", "Spear", "Staff", "Trident", "Warhammer", "Whip"
    ],
    
    paths: [
        "Briarborn: tracking, foraging, survival, wilderness, nature",
        "Fingersmith: tinkering, crafting, picking locks or pockets",
        "Roofrunner: climbing, leaping, balancing, scaling, crawling",
        "Shadowjack: moving silently, hiding in the shadows, sneaking",
        "Truthweaver: convincing, commanding, manipulating, demanding"
    ],
    
    physicalEffects: [
        "Animating", "Attracting", "Binding", "Blossoming", "Consuming", "Creeping",
        "Crushing", "Diminishing", "Dividing", "Duplicating", "Enveloping", "Expanding",
        "Fusing", "Grasping", "Hastening", "Hindering", "Illuminating", "Imprisoning",
        "Levitating", "Opening", "Petrifying", "Phasing", "Piercing", "Pursuing",
        "Reflecting", "Regenerating", "Rending", "Repelling", "Resurrecting", "Screaming",
        "Sealing", "Shapeshifting", "Shielding", "Spawning", "Transmuting", "Transporting"
    ],
    
    etherealEffects: [
        "Avenging", "Compelling", "Banishing", "Concealing", "Bewildering", "Deafening",
        "Deceiving", "Deciphering", "Disguising", "Dispelling", "Emboldening", "Encoding",
        "Energizing", "Enlightening", "Enraging", "Excruciating", "Foreseeing", "Intoxicating",
        "Maddening", "Mesmerizing", "Mindreading", "Nullifying", "Paralyzing", "Revealing",
        "Revolting", "Scrying", "Silencing", "Soothing", "Summoning", "Terrifying",
        "Warding", "Wearying", "Withering"
    ],
    
    physicalElements: [
        "Acid", "Amber", "Bark", "Blood", "Bone", "Brine",
        "Clay", "Crow", "Crystal", "Ember", "Flesh", "Fungus",
        "Glass", "Honey", "Ice", "Insect", "Wood", "Lava",
        "Moss", "Obsidian", "Oil", "Poison", "Rat", "Salt",
        "Sand", "Sap", "Serpent", "Slime", "Stone", "Tar",
        "Thorn", "Vine", "Water", "Wine", "Wood", "Worm"
    ],
    
    etherealElements: [
        "Ash", "Chaos", "Distortion", "Dream", "Dust", "Echo",
        "Ectoplasm", "Fire", "Fog", "Ghost", "Harmony", "Heat",
        "Light", "Lightning", "Memory", "Mind", "Mutation", "Negation",
        "Plague", "Plasma", "Probability", "Rain", "Rot", "Shadow",
        "Smoke", "Snow", "Soul", "Star", "Stasis", "Steam",
        "Thunder", "Time", "Void", "Warp", "Whisper", "Wind"
    ],
    
    physicalForms: [
        "Altar", "Armor", "Arrow", "Beast", "Blade", "Cauldron",
        "Chain", "Chariot", "Claw", "Cloak", "Colossus", "Crown",
        "Elemental", "Eye", "Fountain", "Gate", "Golem", "Hammer",
        "Horn", "Key", "Mask", "Monolith", "Pit", "Prison",
        "Sentinel", "Servant", "Shield", "Spear", "Steed", "Swarm",
        "Tentacle", "Throne", "Torch", "Trap", "Wall", "Web"
    ],
    
    etherealForms: [
        "Aura", "Beacon", "Beam", "Blast", "Blob", "Bolt",
        "Bubble", "Call", "Cascade", "Circle", "Cloud", "Coil",
        "Cone", "Cube", "Dance", "Disk", "Field", "Form",
        "Gaze", "Loop", "Moment", "Nexus", "Portal", "Pulse",
        "Pyramid", "Ray", "Shard", "Sphere", "Spray", "Storm",
        "Swarm", "Torrent", "Touch", "Vortex", "Wave", "Word"
    ],
    
    scars: [
        "Scabbed - Gain an ugly blemish or defect.",
        "Broken - An ability is reduced by 1.",
        "Maimed - Max Health is reduced by 1.",
        "Wounded - Lose the use of a body part.",
        "Twisted - Roll a Mutation.",
        "Splintered - Roll an Insanity."
    ],
    
    mutations: [
        "Animal eyes", "Animal head", "Animal legs", "Animal mouth", "Animal skin", "Animal-form",
        "Ages", "Attracts birds", "Child-form", "Corpulence", "Covered in hair", "Animal arms",
        "Cyclops", "Extra arms", "Extra eyes", "Extra legs", "Forked tongue", "Gender swap",
        "Hunchback", "Monster Trait", "Shrinks", "Item-form", "No eyes", "Shrivels",
        "Long arms", "No mouth", "Skin boils", "Loses teeth", "P. Element-skin", "Slime trail",
        "Monster Feature", "Second face", "Translucent skin", "Sheds skin", "Weeps blood"
    ],
    
    insanities: [
        "Always lies", "Always polite", '"Animal-form"', "Cannot count", "Cannot lie", "Faceblind",
        "Fears birds", "Fears blood", "Fears books", "Fears darkness", "Fears fire", "Fears gold",
        "Fears horses", "Fears iron", "Fears music", "Fears own hand", "Fears PC", "Fears rain",
        "Fears rivers", "Fears silence", "Fears sleep", "Fears sunlight", "Fears the moon", "Fears trees",
        '"Genius"', '"Gorgeous"', "Hates violence", '"Invisible"', '"Invulnerable"', '"Mon. Ability"',
        '"Mon. Feature"', '"Monster Trait"', "Must sing", "New Personality", "Says thoughts", "Sees dead people"
    ],
    
    hazards: [
        { name: "Danger", desc: "One or more threatening enemies descend upon the party." },
        { name: "Encounter", desc: "Someone or something finds the party. Determine their disposition." },
        { name: "Clue", desc: "The party hears, smells, sees, or finds evidence of the next encounter." },
        { name: "Expiration", desc: "Ongoing effects end, torches run out, lanterns need fuel, bellies rumble." },
        { name: "Environment", desc: "The surrounding's state shifts or escalates in some way." },
        { name: "Discovery", desc: "The party finds something interesting and possibly beneficial." }
    ],
    
    ranks: ["Porcelain", "Copper", "Silver", "Gold", "Platinum", "Emerald", "Ruby", "Sapphire", "Pearl", "Diamond"],
    
    xpThresholds: [0, 2, 6, 12, 20, 30, 42, 56, 72, 90],
    
    spells: {
        111: { name: "Acid Stomach", desc: "Anything you eat dissolves instantly." },
        112: { name: "Adhere", desc: "Object is covered in extremely sticky slime." },
        113: { name: "Anchor", desc: "A strong wire sprouts from your arms, affixing itself to two points within 25ft on each side." },
        114: { name: "Animate Object", desc: "An object obeys your commands as best it can." },
        115: { name: "Anthropomorphize", desc: "An animal either gains human intelligence or human appearance for one day." },
        116: { name: "Arcane Eye", desc: "You can see through a magical floating eyeball that flies around at your command." },
        121: { name: "Astral Prison", desc: "An object is frozen in time and space within an invulnerable crystal shell." },
        122: { name: "Attract", desc: "Two objects are strongly magnetically attracted to each other if they come within 25ft." },
        123: { name: "Babble", desc: "A creature must loudly and clearly repeat everything you think. It is otherwise mute." },
        124: { name: "Bait Flower", desc: "A plant sprouts from the ground that emanates the smell of your choice." },
        125: { name: "Beast Form", desc: "You and your possessions transform into a mundane animal." },
        126: { name: "Befuddle", desc: "A creature of your choice is unable to form new short-term memories for the duration of the spell." },
        131: { name: "Bless", desc: "You or a creature have enhanced attacks." },
        132: { name: "Bird Wings", desc: "Your arms turn into large bird wings." },
        133: { name: "Body Swap", desc: "You switch bodies with a creature you touch. If one body dies, the other dies as well." },
        134: { name: "Change Weather", desc: "You may alter the type of weather at will, but you do not otherwise direct it." },
        135: { name: "Charm", desc: "A creature you can see treats you as a friend." },
        136: { name: "Comprehend", desc: "You become fluent in all languages for a short while." },
        141: { name: "Command", desc: "A target obeys a single three-word command that does not harm it." },
        142: { name: "Cone of Foam", desc: "Dense foam sprays from your hand, coating the target." },
        143: { name: "Control Plants", desc: "Nearby plants and trees obey you and gain the ability to move at a slow pace." },
        144: { name: "Cure Wounds", desc: "Restore 1d Health to a creature you touch." },
        145: { name: "Deafen", desc: "All nearby creatures are deafened." },
        146: { name: "Detect Magic", desc: "You can see or hear nearby magical auras." },
        151: { name: "Disassemble", desc: "Any of your body parts may be detached and reattached at will, without causing pain or damage." },
        152: { name: "Disguise", desc: "You may alter the appearance of one character at will as long as they remain humanoid." },
        153: { name: "Displace", desc: "An object appears to be up to 15ft from its actual position." },
        154: { name: "Earthquake", desc: "The ground begins shaking violently. Structures may be damaged or collapse." },
        155: { name: "Elasticity", desc: "Your body can stretch up to 15ft." },
        156: { name: "Elemental Wall", desc: "A straight wall of ice or fire 50ft long and 10ft high rises from the ground." },
        161: { name: "Fear", desc: "A creature becomes terrified of a type of object or person of your choice." },
        162: { name: "Filch", desc: "A visible item teleports to your hands." },
        163: { name: "Flare", desc: "A bright ball of energy fires a trail of light into the sky, revealing your location." },
        164: { name: "Fog Cloud", desc: "A dense fog spreads out from you." },
        165: { name: "Frenzy", desc: "A nearby creature erupts in a frenzy of violence." },
        166: { name: "Gate", desc: "A portal to a random plane opens." },
        211: { name: "Ghost Sound", desc: "You create illusory sounds that seem to come from a direction of your choice." },
        212: { name: "Gravity Shift", desc: "You can change the direction of gravity for yourself." },
        213: { name: "Greed", desc: "A creature develops an overwhelming urge to possess a visible item of your choice." },
        214: { name: "Haste", desc: "Your movement speed is tripled." },
        215: { name: "Hatred", desc: "A creature develops a deep hatred of another creature or group." },
        216: { name: "Hear Whispers", desc: "You can hear faint sounds clearly." },
        221: { name: "Hover", desc: "An object hovers, frictionless, a few feet above the ground." },
        222: { name: "Hypnotize", desc: "A creature enters a trance and will truthfully answer one yes or no question." },
        223: { name: "Icy Touch", desc: "A thick ice layer spreads across a touched surface, up to 15ft in radius." },
        224: { name: "Illuminate", desc: "A floating light moves as you command." },
        225: { name: "Invisibility", desc: "You and all worn items cannot be seen for one minute." },
        226: { name: "Invisible Tether", desc: "Two objects within 15ft of each other cannot be moved more than 15ft apart." },
        231: { name: "Knock", desc: "A nearby mundane or magical lock unlocks ‚Äì loudly." },
        232: { name: "Leap", desc: "You jump up to 50ft, once." },
        233: { name: "Liquid Air", desc: "The air around you becomes swimmable." },
        234: { name: "Magic Dampener", desc: "All nearby magical effects have their effectiveness halved." },
        235: { name: "Manse", desc: "A sturdy, furnished cottage appears for 12 hours." },
        236: { name: "Magic Missile", desc: "You shoot an arcane missile that can seek its target around corners." },
        241: { name: "Manipulate Gravity", desc: "The gravity in a circle with a radius of 50ft triples or is reduced to one-third." },
        242: { name: "Marble Craze", desc: "Your pockets are full of marbles, and will refill every 6 seconds." },
        243: { name: "Masquerade", desc: "A character's appearance and voice becomes identical to those of a character you touch." },
        244: { name: "Miniaturize", desc: "A creature you touch is shrunk down to the size of a mouse." },
        245: { name: "Mirror Image", desc: "An illusory duplicate of yourself appears and is under your control." },
        246: { name: "Mirrorwalk", desc: "A mirror becomes a gateway to another mirrored surface that you looked into today." },
        251: { name: "Missile Shield", desc: "A creature you touch is protected from mundane missile attacks." },
        252: { name: "Multiarm", desc: "You gain an extra arm." },
        253: { name: "Night Sphere", desc: "A 50ft wide sphere of darkness displaying the night sky appears before you." },
        254: { name: "Null Magic", desc: "You counter a spell or negate a magical effect." },
        255: { name: "Objectify", desc: "You become any inanimate object between the size of a grand piano and an apple." },
        256: { name: "Ooze Form", desc: "You become a living jelly." },
        261: { name: "Pacify", desc: "A creature near you has an aversion to violence." },
        262: { name: "Pit", desc: "A pit up to 15ft wide and 15ft deep opens in the ground." },
        263: { name: "Primal Surge", desc: "A creature rapidly evolves into a mutated version of its species." },
        264: { name: "Push/Pull", desc: "An object is pulled towards/pushed away from you with the strength of three men." },
        265: { name: "Raise Dead", desc: "A skeleton rises from the ground to serve you. They are incredibly stupid." },
        266: { name: "Ray of Frost", desc: "A creature or object is encased in ice." },
        311: { name: "Read Mind", desc: "You can hear the surface thoughts of nearby creatures." },
        312: { name: "Repel", desc: "Two objects are strongly magnetically repelled from each other if they come within 15ft." },
        313: { name: "Scry", desc: "You can see through the eyes of a creature you touched earlier today." },
        314: { name: "Sculpt Elements", desc: "All inanimate material behaves like clay in your hands." },
        315: { name: "Shroud", desc: "All creatures around you are invisible until they move." },
        316: { name: "Shuffle", desc: "Two creatures you can see instantly switch places." },
        321: { name: "Sleep", desc: "A creature you can see falls into a light sleep." },
        322: { name: "Slick", desc: "Every surface in a 50ft radius becomes frictionless and slippery." },
        323: { name: "Smoke Form", desc: "Your body becomes living smoke." },
        324: { name: "Snail Knight", desc: "A knight on a giant snail arrives to answer questions about quests and chivalry." },
        325: { name: "Sniff", desc: "You can smell even the faintest traces of scents." },
        326: { name: "Sort", desc: "Inanimate items sort themselves according to categories you set." },
        331: { name: "Spark", desc: "You create a blinding light followed by a frighteningly loud boom." },
        332: { name: "Speak with Dead", desc: "The spirit of a dead body rises and will answer three questions truthfully." },
        333: { name: "Spider Climb", desc: "You can climb surfaces like a spider." },
        334: { name: "Stoneskin", desc: "A creature's skin becomes solid rock." },
        335: { name: "Switcheroo", desc: "You swap places with a creature." },
        336: { name: "Summon Cube", desc: "Once per second you may summon or banish a 5-foot-wide cube of earth." },
        341: { name: "Summon Idol", desc: "A carved stone statue the size of a mule rises from the ground." },
        342: { name: "Swarm", desc: "You become a swarm of crows, rats, or piranhas." },
        343: { name: "Telekinesis", desc: "You may mentally move 1 item under 60lbs." },
        344: { name: "Telepathy", desc: "Two creatures can hear each other's thoughts, no matter how far apart." },
        345: { name: "Teleport", desc: "An object or person you can see is transported from one place to another in a 50ft radius." },
        346: { name: "Thicket", desc: "A thicket of trees and dense brush up to 50ft wide suddenly sprouts up." },
        351: { name: "Time Rush", desc: "Time in a bubble with a 25ft radius starts moving two times faster." },
        352: { name: "Time Slow", desc: "Time in a bubble with a 25ft radius starts moving two times slower." },
        353: { name: "Tristan", desc: "A benign, ordinary, average man appears until end of spell. He will obey polite commands." },
        354: { name: "True Sight", desc: "You see through all nearby illusions." },
        355: { name: "Upwell", desc: "A spring of seawater appears." },
        356: { name: "Vision", desc: "You completely control what a creature sees." },
        361: { name: "Visual Illusion", desc: "A silent, immobile, room-sized illusion of your choice appears." },
        362: { name: "Ward", desc: "A silver circle 50ft across appears. Choose one species that cannot cross it." },
        363: { name: "Web", desc: "Your wrists shoot thick webbing." },
        364: { name: "X-Ray Vision", desc: "You can see through walls, dirt, clothing, etc." },
        365: { name: "Wizard Mark", desc: "Your finger shoots ulfire-colored paint visible only to you at any distance." },
        366: { name: "Zone of Truth", desc: "All creatures in a 50ft bubble are compelled to speak the truth." }
    }
};

// ============ CHARACTER STATE ============
let character = {
    name: "",
    level: 1,
    xp: 0,
    str: 0,
    dex: 0,
    wil: 0,
    maxHealth: 6,
    currentHealth: 6,
    armor: 6,
    archetype: "",
    features: [],
    weapons: [],
    items: [],
    goal: "",
    relationship: "",
    background: "",
    spells: [],
    essence: 0,
    maxEssence: 2,
    prayers: 0,
    maxPrayers: 3,
    quintessence: [],
    implement: "",
    domain: "",
    signatureWeapon: "",
    signatureEnhancements: [],
    path: "",
    scars: [],
    // New properties for archetype features
    attackBonus: 0,
    paths: [],
    miracles: [],
    customMiracles: [],
    featureFlags: {
        augment: false,
        recall: false,
        extract: false,
        shape: false,
        experiment: false,
        craft: false,
        permeable: false,
        quickened: false,
        dazzle: false,
        beacon: false,
        smite: false,
        ward: false,
        enhance: false,
        reflexes: false,
        riposte: false,
        fortitude: false,
        skirmish: false
    },
    experimentSpell: null,
    keptSpells: [],
    tempHealth: 0
};

let combatLog = [];
let rollHistory = [];
let ritualState = {
    active: false,
    step: 0,
    rolledSpells: [],
    keptSpells: [],
    shapeModifier: 0
};

// ============ ARCHETYPE FEATURE DEFINITIONS ============
const ARCHETYPE_FEATURES = {
    mage: [
        { name: "Widen", desc: "Gain two spells.", action: "widen" },
        { name: "Deepen", desc: "Gain two essence.", action: "deepen" },
        { name: "Increase", desc: "Gain one spell and one essence.", action: "increase" },
        { name: "Infuse", desc: "Roll or choose an Element or Form to add to your Quintessence.", action: "infuse" },
        { name: "Augment", desc: "After rolling your spells, roll an Effect for each spell.", action: "augment" },
        { name: "Recall", desc: "You may pick up to two spells to keep before conducting the ritual.", action: "recall" },
        { name: "Extract", desc: "When you conduct the ritual, you may choose the last spell instead of rolling.", action: "extract" },
        { name: "Shape", desc: "After each roll for your spells, you may add or subtract 2 before selecting a spell.", action: "shape" },
        { name: "Experiment", desc: "You create an original spell that you may replace one spell with during the ritual.", action: "experiment" }
    ],
    disciple: [
        { name: "Craft", desc: '"Protection" becomes a shape of your choice.', action: "craft" },
        { name: "Permeable", desc: '"Protection" can be moved through in a direction of your choice.', action: "permeable" },
        { name: "Quickened", desc: '"Protection" can be activated when it is not your turn.', action: "quickened" },
        { name: "Dazzle", desc: '"Light" deals 1d damage to all targets who see it.', action: "dazzle" },
        { name: "Beacon", desc: '"Light" grants +2 on all danger and attack rolls to the wielder of the imbued object.', action: "beacon" },
        { name: "Smite", desc: '"Purify" hurts any target for 2d damage.', action: "smite" },
        { name: "Ward", desc: '"Purify" heals one target near you for an additional 1d damage. Excess healed damage becomes temporary Health until the target rests.', action: "ward" },
        { name: "Enhance", desc: '"Dominion" has an additional or increased effect.', action: "enhance" },
        { name: "Expand", desc: "Gain an additional miracle based on your Favored Domain.", action: "expand" }
    ],
    vagabond: [
        { name: "Skirmish", desc: "Gain +1 Attack Bonus. Your Attack Bonus when unarmed is the same as when using a light weapon.", action: "skirmish" },
        { name: "Fortitude", desc: "Gain +2 Health. When you make a Dying roll, roll 3d and choose two dice.", action: "fortitude" },
        { name: "Amplify", desc: "Roll or choose an Effect to add to your Signature Weapon.", action: "amplify" },
        { name: "Evolve", desc: "Roll or choose an Element to add to your Signature Weapon.", action: "evolve" },
        { name: "Reflexes", desc: "You always go first in initiative.", action: "reflexes" },
        { name: "Riposte", desc: "Once per round, you may make an immediate attack against a target that dealt damage to you.", action: "riposte" },
        { name: "Skilled", desc: "Gain a second Path.", action: "skilled" },
        { name: "Expert", desc: "Gain a third Path.", action: "expert" },
        { name: "Master", desc: "Gain a fourth Path.", action: "master" }
    ]
};

// ============ UTILITY FUNCTIONS ============
function roll(sides) {
    return Math.floor(Math.random() * sides) + 1;
}

function rollMultiple(count, sides) {
    const results = [];
    for (let i = 0; i < count; i++) {
        results.push(roll(sides));
    }
    return results;
}

function pick(array) {
    return array[Math.floor(Math.random() * array.length)];
}

function showTab(tabId) {
    const baseUrl = window.location.href.split('#')[0];
    const newHash = `#${tabId}`;
    history.replaceState(null, '', baseUrl + newHash);

    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelector(`[onclick="showTab('${tabId}')"]`).classList.add('active');
    document.getElementById(tabId).classList.add('active');
}

// ============ CHARACTER SHEET FUNCTIONS ============
function updateDisplay() {
    document.getElementById('display-name').textContent = character.name || '-';
    document.getElementById('display-level').textContent = character.level;
    document.getElementById('display-xp').textContent = character.xp;
    document.getElementById('display-archetype').textContent = character.archetype || '-';
    document.getElementById('display-str').textContent = (character.str >= 0 ? '+' : '') + character.str;
    document.getElementById('display-dex').textContent = (character.dex >= 0 ? '+' : '') + character.dex;
    document.getElementById('display-wil').textContent = (character.wil >= 0 ? '+' : '') + character.wil;
    document.getElementById('display-armor').textContent = character.armor;
    document.getElementById('display-essence').textContent = character.essence;
    document.getElementById('display-max-essence').textContent = character.maxEssence;
    
    // Attack Bonus display (if applicable)
    if (document.getElementById('display-attack-bonus')) {
        document.getElementById('display-attack-bonus').textContent = character.attackBonus;
    }
    
    // Health bar (including temp health)
    const totalHealth = character.currentHealth + (character.tempHealth || 0);
    const healthPercent = Math.max(0, (character.currentHealth / character.maxHealth) * 100);
    const tempHealthPercent = Math.max(0, ((character.tempHealth || 0) / character.maxHealth) * 100);
    document.getElementById('health-bar-fill').style.width = healthPercent + '%';
    
    let healthText = `${character.currentHealth}/${character.maxHealth}`;
    if (character.tempHealth > 0) {
        healthText += ` (+${character.tempHealth} temp)`;
    }
    document.getElementById('health-display').textContent = healthText;
    
    // Weapons
    const weaponsList = document.getElementById('weapons-list');
    weaponsList.innerHTML = character.weapons.map(w => `<div class="item"><span>${w}</span></div>`).join('') || '<p>No weapons</p>';
    
    // Signature Weapon display for Vagabond
    if (character.archetype === 'vagabond' && character.signatureWeapon) {
        const sigWeaponHtml = `
            <div class="item signature-weapon">
                <span><strong>Signature:</strong> ${character.signatureWeapon} 
                (${character.signatureEnhancements.join(', ')})</span>
            </div>
        `;
        weaponsList.innerHTML = sigWeaponHtml + weaponsList.innerHTML;
    }
    
    // Inventory
    const inventoryList = document.getElementById('inventory-list');
    inventoryList.innerHTML = character.items.map((item, i) => `
        <div class="item">
            <span>${item.name} (${item.location})</span>
            <button class="btn-small btn-danger" onclick="removeItem(${i})">√ó</button>
        </div>
    `).join('') || '<p>No items</p>';
    
    // Features
    const featuresList = document.getElementById('features-list');
    featuresList.innerHTML = character.features.map(f => `<div class="item"><span>${f}</span></div>`).join('') || '<p>No features</p>';
    
    // Paths for Vagabond
    if (character.archetype === 'vagabond' && character.paths.length > 0) {
        const pathsHtml = character.paths.map(p => `<div class="item"><span>Path: ${p}</span></div>`).join('');
        featuresList.innerHTML += pathsHtml;
    }
    
    // Details
    document.getElementById('display-goal').textContent = character.goal || '-';
    document.getElementById('display-relationship').textContent = character.relationship || '-';
    document.getElementById('display-background').textContent = character.background || '-';
    
    // Scars
    const scarsList = document.getElementById('scars-list');
    scarsList.innerHTML = character.scars.map(s => `<div class="item"><span>${s}</span></div>`).join('') || '<p>No scars</p>';
    
    // Spells (Mage)
    const memorizedSpells = document.getElementById('memorized-spells');
    if (character.archetype === 'mage') {
        memorizedSpells.innerHTML = character.spells.map((s, i) => `
            <div class="item">
                <span><strong>${s.name}:</strong> ${s.desc}${s.effect ? ' [' + s.effect + ']' : ''}</span>
                <button class="btn-small" onclick="castSpell(${i})">Cast (${character.essence}/${character.maxEssence})</button>
            </div>
        `).join('') || '<p>No spells memorized</p>';
    } else {
        memorizedSpells.innerHTML = '<p>Not a Mage</p>';
    }
    
    // Quintessence
    const quintList = document.getElementById('quintessence-list');
    quintList.innerHTML = character.quintessence.map(q => `<div class="item"><span>${q}</span></div>`).join('') || '<p>No quintessence</p>';
    
    // Miracles (Disciple)
    updateMiraclesDisplay();
    
    // Update feature selection panel
    updateFeatureSelectionPanel();
}

function updateMiraclesDisplay() {
    const miraclesContainer = document.getElementById('miracles-list');
    if (!miraclesContainer) return;
    
    if (character.archetype !== 'disciple') {
        miraclesContainer.innerHTML = '<p>Not a Disciple</p>';
        return;
    }
    
    let miraclesHtml = `
        <div class="prayers-display">
            <strong>Prayers:</strong> ${character.prayers}/${character.maxPrayers}
            <button class="btn-small" onclick="commune()">Commune at Temple</button>
        </div>
        <div class="domain-display">
            <strong>Favored Domain:</strong> ${character.domain}
        </div>
        <h4>Miracles:</h4>
    `;
    
    // Base miracles
    const baseMiracles = [
        { name: 'Protection', desc: getMiracleDescription('Protection') },
        { name: 'Light', desc: getMiracleDescription('Light') },
        { name: 'Purify', desc: getMiracleDescription('Purify') },
        { name: 'Dominion', desc: getMiracleDescription('Dominion') }
    ];
    
    baseMiracles.forEach(m => {
        miraclesHtml += `
            <div class="item miracle">
                <span><strong>${m.name}:</strong> ${m.desc}</span>
                <button class="btn-small" onclick="activateMiracle('${m.name}')">${character.prayers > 0 ? 'Activate' : 'No Prayers'}</button>
            </div>
        `;
    });
    
    // Custom miracles from Expand
    character.customMiracles.forEach((m, i) => {
        miraclesHtml += `
            <div class="item miracle custom">
                <span><strong>${m.name}:</strong> ${m.desc}</span>
                <button class="btn-small" onclick="activateMiracle('custom_${i}')">${character.prayers > 0 ? 'Activate' : 'No Prayers'}</button>
            </div>
        `;
    });
    
    miraclesContainer.innerHTML = miraclesHtml;
}

function getMiracleDescription(miracleName) {
    const flags = character.featureFlags;
    
    switch(miracleName) {
        case 'Protection':
            let protDesc = 'A small, flat, immovable, impenetrable barrier wall forms near you.';
            if (flags.craft) protDesc += ' (Custom Shape)';
            if (flags.permeable) protDesc += ' (Directional Permeability)';
            if (flags.quickened) protDesc += ' (Reaction Activation)';
            return protDesc;
            
        case 'Light':
            let lightDesc = 'Imbue an object with light (long duration) or create a blinding flash (short duration).';
            if (flags.dazzle) lightDesc += ' Deals 1d damage to all who see the flash.';
            if (flags.beacon) lightDesc += ' Wielder gains +2 on danger and attack rolls.';
            return lightDesc;
            
        case 'Purify':
            let purifyDesc = '';
            if (flags.smite) {
                purifyDesc = 'Hurt any target near you for 2d damage.';
            } else {
                purifyDesc = 'Heal a friendly target near you for 1d or hurt an unholy target for 1d.';
            }
            if (flags.ward) {
                purifyDesc += ' Heal an additional 1d; excess becomes temporary HP.';
            }
            return purifyDesc;
            
        case 'Dominion':
            let domDesc = `Effect based on ${character.domain} domain.`;
            if (flags.enhance) domDesc += ' (Enhanced effect)';
            return domDesc;
            
        default:
            return 'Unknown miracle.';
    }
}

function modifyHealth(amount) {
    // Handle temp health first when taking damage
    if (amount < 0 && character.tempHealth > 0) {
        const damageAbs = Math.abs(amount);
        if (character.tempHealth >= damageAbs) {
            character.tempHealth -= damageAbs;
            updateDisplay();
            saveCharacter();
            logCombat(`Absorbed ${damageAbs} damage with temporary HP. Temp HP remaining: ${character.tempHealth}`);
            return;
        } else {
            const remainingDamage = damageAbs - character.tempHealth;
            character.tempHealth = 0;
            amount = -remainingDamage;
        }
    }
    
    if (character.currentHealth === character.maxHealth) {
        character.tempHealth++;
    }
    character.currentHealth =  Math.min(character.maxHealth, character.currentHealth + amount);
    if (character.currentHealth <= 0) {
        newAlert('Character is at 0 HP or less! Do a dying roll in the Combat tab.');
    }
    updateDisplay();
    saveCharacter();
}

function fullHeal() {
    character.currentHealth = character.maxHealth;
    character.tempHealth = 0; // Temp health is lost on rest
    updateDisplay();
    saveCharacter();
    logCombat('Full rest - Health restored to maximum, temporary HP lost');
}

function useMedicine() {
    const medIdx = character.items.findIndex(i => i.name.toLowerCase().includes('medicine'));
    if (medIdx === -1) {
        newAlert('No medicine in inventory!');
        return;
    }
    modifyHealth(1);
    character.items.splice(medIdx, 1);
    updateDisplay();
    logCombat('Used medicine - Restored 1 HP');
}

function addItem() {
    const name = document.getElementById('new-item').value.trim();
    const location = document.getElementById('item-location').value;
    if (!name) return;
    
    const beltItems = character.items.filter(i => i.location === 'belt').length;
    const backpackItems = character.items.filter(i => i.location === 'backpack').length;
    
    if (location === 'belt' && beltItems >= 2) {
        newAlert('Belt can only hold 2 items!');
        return;
    }
    if (location === 'backpack' && backpackItems >= 6) {
        newAlert('Backpack can only hold 6 items!');
        return;
    }
    
    character.items.push({ name, location });
    document.getElementById('new-item').value = '';
    updateDisplay();
    saveCharacter();
}

function removeItem(index) {
    character.items.splice(index, 1);
    updateDisplay();
    saveCharacter();
}

function addXP(amount) {
    character.xp += amount;
    updateDisplay();
    saveCharacter();
}

function increaseStat(statName) {
    character[statName]++;
    updateDisplay();
    saveCharacter();
    closeDialog();
}

function checkLevelUp() {
    const xpThresholds = [0, 2, 6, 12, 20, 30, 42, 56, 72, 90];
    const ranks = ['Porcelain', 'Copper', 'Silver', 'Gold', 'Platinum', 'Emerald', 'Ruby', 'Sapphire', 'Pearl', 'Diamond'];
    const featureLevels = [3, 5, 7, 9];
    
    let newLevel = 1;
    for (let i = 0; i < xpThresholds.length; i++) {
        if (character.xp >= xpThresholds[i]) {
            newLevel = i + 1;
        }
    }
    
    if (newLevel > character.level) {
        const oldLevel = character.level;
        character.level = newLevel;
        
        let gain = newLevel % 2 === 0 ? '+1 to an ability' : '+1 feature';
        
        // Check if this is a feature level
        if (featureLevels.includes(newLevel)) {
            gain += '\n‚≠ê Choose an Archetype Feature!';
        }
        
        let lvlupMsg = `${oldLevel} ‚Üí ${newLevel} (${ranks[newLevel-1]})<br>You gain: ${gain}`;

        if (newLevel % 2 === 0) {
            lvlupMsg += `<br>Choose an ability to increase
            <div class="dialog-buttons"><button onclick="increaseStat('str')">+1 STR</button><button onclick="increaseStat('dex')">+1 DEX</button><button onclick="increaseStat('wil')">+1 WIL</button></div>`;
        } else {
            lvlupMsg += `<div class="dialog-buttons"><button onclick="closeDialog()">OK</div>`
        }

        createDialog("LEVEL UP!", lvlupMsg);
        
        character.maxHealth = 6 + character.str;
    }
    updateDisplay();
    saveCharacter();
}

function populateSelect(selectId, options) {
    const select = document.getElementById(selectId);
    select.innerHTML = '';
    
    options.forEach(item => {
        const option = document.createElement('option');
        option.value = item;
        option.textContent = item;
        select.appendChild(option);
    });
}

// ============ FEATURE SELECTION ============
function updateFeatureSelectionPanel() {
    const featurePanel = document.getElementById('feature-selection-panel');
    if (!featurePanel) return;
    
    const featureLevels = [3, 5, 7, 9];
    const earnedFeatures = featureLevels.filter(l => character.level >= l).length;
    const usedFeatures = countUsedArchetypeFeatures();
    
    const availableFeatures = earnedFeatures - usedFeatures;
    
    if (availableFeatures <= 0 || !character.archetype) {
        featurePanel.innerHTML = '<p>No feature slots available.</p>';
        return;
    }
    
    const features = ARCHETYPE_FEATURES[character.archetype] || [];
    
    let html = `
        <h4>Choose Archetype Feature (${availableFeatures} available)</h4>
        <div class="feature-grid">
    `;
    
    features.forEach(f => {
        const isOwned = hasFeature(f.action);
        const canSelect = !isOwned && canSelectFeature(f.action);
        
        html += `
            <div class="feature-option ${isOwned ? 'owned' : ''} ${!canSelect ? 'disabled' : ''}">
                <strong>${f.name}</strong>
                <p>${f.desc}</p>
                ${isOwned ? '<span class="badge">Owned</span>' : 
                  canSelect ? `<button onclick="selectFeature('${f.action}')">Select</button>` : 
                  '<span class="badge">Unavailable</span>'}
            </div>
        `;
    });
    
    html += '</div>';
    featurePanel.innerHTML = html;
}

function countUsedArchetypeFeatures() {
    const featureNames = ARCHETYPE_FEATURES[character.archetype]?.map(f => f.name) || [];
    return character.features.filter(f => featureNames.some(fn => f.includes(fn))).length;
}

function hasFeature(action) {
    return character.featureFlags[action] === true;
}

function canSelectFeature(action) {
    // Check prerequisites
    switch(action) {
        case 'expert':
            return hasFeature('skilled');
        case 'master':
            return hasFeature('expert');
        default:
            return true;
    }
}

function selectFeature(action) {
    const features = ARCHETYPE_FEATURES[character.archetype] || [];
    const feature = features.find(f => f.action === action);
    
    if (!feature) return;
    
    // Apply the feature
    switch(action) {
        // Mage features
        case 'widen':
            character.spells.push(generateRandomSpell());
            character.spells.push(generateRandomSpell());
            character.features.push('Widen: +2 spells');
            break;
            
        case 'deepen':
            character.maxEssence += 2;
            character.essence += 2;
            character.features.push('Deepen: +2 max essence');
            break;
            
        case 'increase':
            character.spells.push(generateRandomSpell());
            character.maxEssence += 1;
            character.essence += 1;
            character.features.push('Increase: +1 spell, +1 essence');
            break;
            
        case 'infuse':
            showInfuseDialog();
            return; // Don't complete yet, dialog will handle it
            
        case 'augment':
            character.featureFlags.augment = true;
            character.features.push('Augment: Roll Effect for each spell');
            break;
            
        case 'recall':
            character.featureFlags.recall = true;
            character.features.push('Recall: Keep up to 2 spells during ritual');
            break;
            
        case 'extract':
            character.featureFlags.extract = true;
            character.features.push('Extract: Choose last spell in ritual');
            break;
            
        case 'shape':
            character.featureFlags.shape = true;
            character.features.push('Shape: ¬±2 to spell rolls');
            break;
            
        case 'experiment':
            showExperimentDialog();
            return;
            
        // Disciple features
        case 'craft':
            character.featureFlags.craft = true;
            character.features.push('Craft: Custom Protection shape');
            break;
            
        case 'permeable':
            character.featureFlags.permeable = true;
            character.features.push('Permeable: Directional Protection');
            break;
            
        case 'quickened':
            character.featureFlags.quickened = true;
            character.features.push('Quickened: Reaction Protection');
            break;
            
        case 'dazzle':
            character.featureFlags.dazzle = true;
            character.features.push('Dazzle: Light deals 1d damage');
            break;
            
        case 'beacon':
            character.featureFlags.beacon = true;
            character.features.push('Beacon: Light grants +2 to rolls');
            break;
            
        case 'smite':
            character.featureFlags.smite = true;
            character.features.push('Smite: Purify deals 2d to any target');
            break;
            
        case 'ward':
            character.featureFlags.ward = true;
            character.features.push('Ward: Purify heals extra 1d, excess = temp HP');
            break;
            
        case 'enhance':
            character.featureFlags.enhance = true;
            character.features.push('Enhance: Improved Dominion');
            break;
            
        case 'expand':
            showExpandDialog();
            return;
            
        // Vagabond features
        case 'skirmish':
            character.attackBonus += 1;
            character.featureFlags.skirmish = true;
            character.features.push('Skirmish: +1 AB, improved unarmed');
            break;
            
        case 'fortitude':
            character.maxHealth += 2;
            character.currentHealth += 2;
            character.featureFlags.fortitude = true;
            character.features.push('Fortitude: +2 HP, better Dying rolls');
            break;
            
        case 'amplify':
            showAmplifyDialog();
            return;
            
        case 'evolve':
            showEvolveDialog();
            return;
            
        case 'reflexes':
            character.featureFlags.reflexes = true;
            character.features.push('Reflexes: Always first in initiative');
            break;
            
        case 'riposte':
            character.featureFlags.riposte = true;
            character.features.push('Riposte: Counter-attack once/round');
            break;
            
        case 'skilled':
            showPathDialog('skilled');
            return;
            
        case 'expert':
            showPathDialog('expert');
            return;
            
        case 'master':
            showPathDialog('master');
            return;
    }
    
    character.featureFlags[action] = true;
    updateDisplay();
    saveCharacter();
    newAlert(`Feature acquired: ${feature.name}`);
}

// ============ FEATURE DIALOGS ============
function showInfuseDialog() {
    const options = [...TABLES.physicalElements, ...TABLES.etherealElements, ...TABLES.physicalForms, ...TABLES.etherealForms];
    
    const dialog = createDialog('Infuse Quintessence', `
        <p>Choose an Element or Form to add to your Quintessence:</p>
        <select id="infuse-choice">
            ${options.map(o => `<option value="${o}">${o}</option>`).join('')}
        </select>
        <button onclick="randomizeDialogSelect('infuse-choice', ${JSON.stringify(options).replace(/"/g, '&quot;')})">üé≤ Random</button>
        <div class="dialog-buttons">
            <button onclick="confirmInfuse()">Confirm</button>
            <button onclick="closeDialog()">Cancel</button>
        </div>
    `);
}

function confirmInfuse() {
    const choice = document.getElementById('infuse-choice').value;
    character.quintessence.push(choice);
    character.featureFlags.infuse = true;
    character.features.push(`Infuse: +${choice} Quintessence`);
    closeDialog();
    updateDisplay();
    saveCharacter();
    alert(`Quintessence expanded with: ${choice}`);
}

function showExperimentDialog() {
    const dialog = createDialog('Create Experiment Spell', `
        <p>Design your original spell that can replace one spell during rituals:</p>
        <label>Spell Name:</label>
        <input type="text" id="experiment-name" placeholder="Spell name">
        <label>Spell Description:</label>
        <textarea id="experiment-desc" placeholder="Describe the spell effect"></textarea>
        <div class="dialog-buttons">
            <button onclick="confirmExperiment()">Create Spell</button>
            <button onclick="closeDialog()">Cancel</button>
        </div>
    `);
}

function confirmExperiment() {
    const name = document.getElementById('experiment-name').value.trim();
    const desc = document.getElementById('experiment-desc').value.trim();
    
    if (!name || !desc) {
        alert('Please provide both a name and description for your spell.');
        return;
    }
    
    character.experimentSpell = { name, desc };
    character.featureFlags.experiment = true;
    character.features.push(`Experiment: ${name}`);
    closeDialog();
    updateDisplay();
    saveCharacter();
    alert(`Created experiment spell: ${name}`);
}

function showExpandDialog() {
    const dialog = createDialog('Expand - Create Domain Miracle', `
        <p>Create an additional miracle based on your Favored Domain (${character.domain}):</p>
        <label>Miracle Name:</label>
        <input type="text" id="expand-name" placeholder="Miracle name">
        <label>Miracle Effect:</label>
        <textarea id="expand-desc" placeholder="Describe the miracle effect related to ${character.domain}"></textarea>
        <div class="dialog-buttons">
            <button onclick="confirmExpand()">Create Miracle</button>
            <button onclick="closeDialog()">Cancel</button>
        </div>
    `);
}

function confirmExpand() {
    const name = document.getElementById('expand-name').value.trim();
    const desc = document.getElementById('expand-desc').value.trim();
    
    if (!name || !desc) {
        alert('Please provide both a name and description for your miracle.');
        return;
    }
    
    character.customMiracles.push({ name, desc });
    character.featureFlags.expand = true;
    character.features.push(`Expand: ${name} miracle`);
    closeDialog();
    updateDisplay();
    saveCharacter();
    alert(`Created new miracle: ${name}`);
}

function showAmplifyDialog() {
    const options = [...TABLES.physicalEffects, ...TABLES.etherealEffects];
    
    const dialog = createDialog('Amplify Signature Weapon', `
        <p>Choose an Effect to add to your Signature Weapon:</p>
        <select id="amplify-choice">
            ${options.map(o => `<option value="${o}">${o}</option>`).join('')}
        </select>
        <button onclick="randomizeDialogSelect('amplify-choice', ${JSON.stringify(options).replace(/"/g, '&quot;')})">üé≤ Random</button>
        <div class="dialog-buttons">
            <button onclick="confirmAmplify()">Confirm</button>
            <button onclick="closeDialog()">Cancel</button>
        </div>
    `);
}

function confirmAmplify() {
    const choice = document.getElementById('amplify-choice').value;
    character.signatureEnhancements.push(choice);
    character.featureFlags.amplify = true;
    character.features.push(`Amplify: +${choice} to Signature Weapon`);
    closeDialog();
    updateDisplay();
    saveCharacter();
    alert(`Added ${choice} to Signature Weapon!`);
}

function showEvolveDialog() {
    const options = [...TABLES.physicalElements, ...TABLES.etherealElements];
    
    const dialog = createDialog('Evolve Signature Weapon', `
        <p>Choose an Element to add to your Signature Weapon:</p>
        <select id="evolve-choice">
            ${options.map(o => `<option value="${o}">${o}</option>`).join('')}
        </select>
        <button onclick="randomizeDialogSelect('evolve-choice', ${JSON.stringify(options).replace(/"/g, '&quot;')})">üé≤ Random</button>
        <div class="dialog-buttons">
            <button onclick="confirmEvolve()">Confirm</button>
            <button onclick="closeDialog()">Cancel</button>
        </div>
    `);
}

function confirmEvolve() {
    const choice = document.getElementById('evolve-choice').value;
    character.signatureEnhancements.push(choice);
    character.featureFlags.evolve = true;
    character.features.push(`Evolve: +${choice} to Signature Weapon`);
    closeDialog();
    updateDisplay();
    saveCharacter();
    alert(`Added ${choice} to Signature Weapon!`);
}

function showPathDialog(tier) {
    const existingPaths = [character.path, ...character.paths];
    const availablePaths = TABLES.paths.filter(p => !existingPaths.includes(p));
    
    const dialog = createDialog(`Select New Path (${tier})`, `
        <p>Choose a new Path:</p>
        <select id="path-choice">
            ${availablePaths.map(p => `<option value="${p}">${p}</option>`).join('')}
        </select>
        <button onclick="randomizeDialogSelect('path-choice', ${JSON.stringify(availablePaths).replace(/"/g, '&quot;')})">üé≤ Random</button>
        <div class="dialog-buttons">
            <button onclick="confirmPath('${tier}')">Confirm</button>
            <button onclick="closeDialog()">Cancel</button>
        </div>
    `);
}

function confirmPath(tier) {
    const choice = document.getElementById('path-choice').value;
    character.paths.push(choice);
    character.featureFlags[tier] = true;
    
    const tierNames = { skilled: 'Skilled', expert: 'Expert', master: 'Master' };
    // character.features.push(`${tierNames[tier]}: ${choice} Path`);
    closeDialog();
    updateDisplay();
    saveCharacter();
    alert(`Gained new path: ${choice}`);
}

function createDialog(title, content) {
    // Remove existing dialog if present
    closeDialog();
    
    const overlay = document.createElement('div');
    overlay.id = 'dialog-overlay';
    overlay.className = 'dialog-overlay';
    overlay.innerHTML = `
        <div class="dialog">
            <h3>${title}</h3>
            ${content}
        </div>
    `;
    document.body.appendChild(overlay);
    return overlay;
}

function newAlert(text) {
    createDialog("üõà", `${text}<div class="dialog-buttons"><button onclick="closeDialog()">OK</button></div>`);
}

function closeDialog() {
    const dialog = document.getElementById('dialog-overlay');
    if (dialog) dialog.remove();
}

function randomizeDialogSelect(selectId, options) {
    document.getElementById(selectId).value = pick(options);
}

// ============ DISCIPLE FUNCTIONS ============

function commune() {
    if (character.archetype !== 'disciple') {
        newAlert('Only Disciples can commune at temples!');
        return;
    }
    
    character.prayers = character.maxPrayers;
    updateDisplay();
    saveCharacter();
    newAlert('Communed at temple - Prayers restored!');
    logCombat('Communed at temple - Prayers restored');
}

function activateMiracle(miracleName) {
    if (character.prayers <= 0) {
        newAlert('No prayers remaining!');
        return;
    }
    
    character.prayers--;
    
    let effect = '';
    switch(miracleName) {
        case 'Protection':
            effect = 'Protection barrier formed!';
            if (character.featureFlags.craft) effect += ' (Custom shape)';
            if (character.featureFlags.permeable) effect += ' (Directional)';
            break;
            
        case 'Light':
            effect = 'Light manifested!';
            if (character.featureFlags.dazzle) {
                const damage = roll(6);
                effect += ` Dazzle damage: ${damage}`;
            }
            if (character.featureFlags.beacon) effect += ' (+2 to wielder rolls)';
            break;
            
        case 'Purify':
            if (character.featureFlags.smite) {
                const damage = roll(6) + roll(6);
                effect = `Smite! Dealt ${damage} damage`;
            } else {
                const healing = roll(6);
                effect = `Purify: ${healing} healing/damage`;
            }
            if (character.featureFlags.ward) {
                const extraHeal = roll(6);
                effect += ` Ward: +${extraHeal} healing`;
            }
            break;
            
        case 'Dominion':
            effect = `Dominion (${character.domain}) activated!`;
            if (character.featureFlags.enhance) effect += ' (Enhanced)';
            break;
            
        default:
            if (miracleName.startsWith('custom_')) {
                const idx = parseInt(miracleName.split('_')[1]);
                const miracle = character.customMiracles[idx];
                effect = `${miracle.name} activated!`;
            }
    }
    
    updateDisplay();
    saveCharacter();
    logCombat(`Miracle: ${effect}`);
    newAlert(effect);
}

// ============ MAGE RITUAL SYSTEM ============
function conductRitual() {
    if (character.archetype !== 'mage') {
        newAlert('Only Mages can conduct rituals!');
        return;
    }
    
    // Check for Recall feature
    if (character.featureFlags.recall && character.spells.length > 0) {
        showRecallDialog();
    } else {
        performRitual([]);
    }
}

function showRecallDialog() {
    const spellsHtml = character.spells.map((s, i) => `
        <div class="spell-option">
            <label>
                <input type="checkbox" class="recall-spell" value="${i}">
                <strong>${s.name}</strong>: ${s.desc}${s.effect ? ' [' + s.effect + ']' : ''}
            </label>
        </div>
    `).join('');
    
    createDialog('Recall - Keep Spells', `
        <p>Select up to 2 spells to keep:</p>
        <div class="spell-list">${spellsHtml}</div>
        <div class="dialog-buttons">
            <button onclick="confirmRecall()">Continue Ritual</button>
            <button onclick="performRitual([]); closeDialog();">Skip (Keep None)</button>
        </div>
    `);
}

function confirmRecall() {
    const checked = document.querySelectorAll('.recall-spell:checked');
    if (checked.length > 2) {
        alert('You can only keep up to 2 spells!');
        return;
    }
    
    const keptIndices = Array.from(checked).map(c => parseInt(c.value));
    const keptSpells = keptIndices.map(i => character.spells[i]);
    
    closeDialog();
    performRitual(keptSpells);
}

function performRitual(keptSpells) {
    const spellCount = character.maxEssence; // Spells = max essence by default
    
    ritualState = {
        active: true,
        step: 0,
        totalSpells: spellCount,
        rolledSpells: [...keptSpells],
        keptSpells: keptSpells
    };
    
    if (character.featureFlags.shape || character.featureFlags.extract) {
        showRitualStep();
    } else {
        // Simple ritual without Shape or Extract
        const newSpells = [];
        for (let i = keptSpells.length; i < spellCount; i++) {
            let spell = generateRandomSpell();
            if (character.featureFlags.augment) {
                spell.effect = pick([...TABLES.physicalEffects, ...TABLES.etherealEffects]);
            }
            newSpells.push(spell);
        }
        
        character.spells = [...keptSpells, ...newSpells];
        
        // Check for Experiment
        if (character.featureFlags.experiment && character.experimentSpell) {
            showExperimentReplace();
        } else {
            completeRitual();
        }
    }
}

function showRitualStep() {
    const remaining = ritualState.totalSpells - ritualState.rolledSpells.length;
    
    if (remaining <= 0) {
        character.spells = ritualState.rolledSpells;
        if (character.featureFlags.experiment && character.experimentSpell) {
            showExperimentReplace();
        } else {
            completeRitual();
        }
        return;
    }
    
    // Last spell with Extract
    const isLastSpell = remaining === 1 && character.featureFlags.extract;
    
    if (isLastSpell) {
        showExtractDialog();
    } else {
        showShapeDialog();
    }
}

function showShapeDialog() {
    const d1 = roll(6);
    const adj_d1 = Math.ceil(d1 / 2);
    const d2 = roll(6);
    const d3 = roll(6);
    
    if (character.featureFlags.shape) {
        const d1_options = [d1 - 2, d1, d1 + 2].map(r => Math.ceil(r / 2)).filter(val => val >= 1 && val <= 6);;
        const d2_options = [d2 - 2, d2, d2 + 2].filter(val => val >= 1 && val <= 6);;
        const d3_options = [d3 - 2, d3, d3 + 2].filter(val => val >= 1 && val <= 6);;
        let possibleSpells = [];
        d1_options.forEach(opt1 => {
            d2_options.forEach(opt2 => {
                d3_options.forEach(opt3 => {

                    // Calculate the lookup code
                    const lookupCode = (opt1 * 100) + (opt2 * 10) + opt3;
                    const spellEntry = TABLES.spells[lookupCode];

                    // Only add if the spell exists in the table
                    if (spellEntry) {
                        possibleSpells.push({
                            code: lookupCode,
                            roll: `${opt1}-${opt2}-${opt3}`,
                            spell: spellEntry // name and desc
                        });
                    }

                });
            });
        });

        createDialog('Shape Spell', `
            <p>Rolled: ${d1}, ${d2}, ${d3}</p>
            <p>Use Shape to adjust each component by ¬±2:</p>
            <label>Possible Spells:</label>
            <select id="shape-spell">
                ${possibleSpells.map(o => `<option value="${o.code}">(${o.roll}) ${o.spell.name}: ${o.spell.desc}</option>`).join('')}
            </select>
            <div class="dialog-buttons">
                <button onclick="confirmShapeSpell()">Accept Spell</button>
            </div>
        `);
    } else {
        // No shape, just generate and add
        const lookupCode = (adj_d1 * 100) + (d2 * 10) + d3;
        const spell = TABLES.spells[lookupCode];
        if (character.featureFlags.augment) {
            const allEffects = [...TABLES.physicalEffects, ...TABLES.etherealEffects];
            spell.effect = pick(allEffects);
        }
        ritualState.rolledSpells.push(spell);
        showRitualStep();
    }
}

function confirmShapeSpell() {
    const spellCode = parseInt(document.getElementById('shape-spell').value);
    
    const spell = TABLES.spells[spellCode];
    
    if (character.featureFlags.augment) {
        const allEffects = [...TABLES.physicalEffects, ...TABLES.etherealEffects];
        spell.effect = pick(allEffects);
    }
    
    ritualState.rolledSpells.push(spell);
    closeDialog();
    showRitualStep();
}

function showExtractDialog() {
    const spellsHtml = ritualState.rolledSpells.map((s, i) => `
        <div class="spell-option">
            <label>
                <strong>${s.name}</strong>: ${s.desc}${s.effect ? ' [' + s.effect + ']' : ''}
            </label>
        </div>
    `).join('');
    
    createDialog('Extract - Choose Final Spell', `
        <p>Spells gained so far:</p>
        <div class="spell-list">${spellsHtml}</div>
        <p>Choose your final spell:</p>
        <label>Spell:</label>
        <select id="extract-spell">
            ${Object.entries(TABLES.spells).map(([i, e]) => `<option value="${i}">${e.name}: ${e.desc}</option>`).join('')}
        </select>
        <div class="dialog-buttons">
            <button onclick="confirmExtract()">Create Spell</button>
        </div>
    `);
}

function confirmExtract() {
    const spellCode = parseInt(document.getElementById('extract-spell').value);
    
    const spell = TABLES.spells[spellCode];
    
    if (character.featureFlags.augment) {
        const allEffects = [...TABLES.physicalEffects, ...TABLES.etherealEffects];
        spell.effect = pick(allEffects);
    }
    
    ritualState.rolledSpells.push(spell);
    closeDialog();
    showRitualStep();
}

function showExperimentReplace() {
    const spellsHtml = character.spells.map((s, i) => `
        <div class="spell-option">
            <label>
                <input type="radio" name="replace-spell" value="${i}">
                <strong>${s.name}</strong>: ${s.desc}${s.effect ? ' [' + s.effect + ']' : ''}
            </label>
        </div>
    `).join('');
    
    createDialog('Experiment - Replace Spell?', `
        <p>Replace one spell with your Experiment: <strong>${character.experimentSpell.name}</strong>?</p>
        <p><em>${character.experimentSpell.desc}</em></p>
        <div class="spell-list">${spellsHtml}</div>
        <div class="dialog-buttons">
            <button onclick="confirmExperimentReplace()">Replace Selected</button>
            <button onclick="completeRitual(); closeDialog();">Keep All (Skip)</button>
        </div>
    `);
}

function confirmExperimentReplace() {
    const selected = document.querySelector('input[name="replace-spell"]:checked');
    if (!selected) {
        alert('Select a spell to replace or click Skip.');
        return;
    }
    
    const idx = parseInt(selected.value);
    character.spells[idx] = { ...character.experimentSpell };
    closeDialog();
    completeRitual();
}

function completeRitual() {
    character.essence = character.maxEssence;
    ritualState.active = false;
    updateDisplay();
    saveCharacter();
    newAlert('Ritual complete! Spells memorized and essence restored.');
    logCombat('Conducted ritual - spells and essence refreshed');
}

// ============ CHARACTER CREATION ============
function rollAbilities() {
    const row = pick(TABLES.abilities);
    document.getElementById('create-str').value = row.str;
    document.getElementById('create-dex').value = row.dex;
    document.getElementById('create-wil').value = row.wil;
}

function randomName(gender) {
    const firstName = gender === 'male' ? pick(TABLES.maleNames) : pick(TABLES.femaleNames);
    const surname = Math.random() > 0.5 ? pick(TABLES.lowerSurnames) : pick(TABLES.upperSurnames);
    document.getElementById('char-name').value = firstName + ' ' + surname;
}

function updateArchetypeOptions() {
    const archetype = document.getElementById('create-archetype').value;
    const optionsDiv = document.getElementById('archetype-options');
    
    if (!archetype) {
        optionsDiv.style.display = 'none';
        return;
    }
    
    optionsDiv.style.display = 'block';
    
    if (archetype === 'mage') {
        optionsDiv.innerHTML = `
            <h4>Mage Options</h4>
            <label>Implement:</label>
            <select id="mage-implement">
                ${TABLES.implements.map(i => `<option value="${i}">${i}</option>`).join('')}
            </select>
            <button class="btn-small" onclick="document.getElementById('mage-implement').value=pick(TABLES.implements)">üé≤</button>
            <label>Quintessence (Element or Form):</label>
            <select id="mage-quint">
                ${[...TABLES.physicalElements, ...TABLES.etherealElements, ...TABLES.physicalForms, ...TABLES.etherealForms].map(q => `<option value="${q}">${q}</option>`).join('')}
            </select>
            <button class="btn-small" onclick="randomQuintessence()">üé≤</button>
            <p><em>You will start with 2 random spells and 2 essence.</em></p>
        `;
    } else if (archetype === 'disciple') {
        optionsDiv.innerHTML = `
            <h4>Disciple Options</h4>
            <label>Favored Domain:</label>
            <select id="disciple-domain">
                ${TABLES.domains.map(d => `<option value="${d}">${d}</option>`).join('')}
            </select>
            <button class="btn-small" onclick="document.getElementById('disciple-domain').value=pick(TABLES.domains)">üé≤</button>
            <p><strong>Miracles:</strong> Protection, Light, Purify, Dominion</p>
            <p><em>You will start with 3 prayers.</em></p>
        `;
    } else if (archetype === 'vagabond') {
        optionsDiv.innerHTML = `
            <h4>Vagabond Options</h4>
            <label>Signature Weapon:</label>
            <select id="vagabond-weapon">
                ${TABLES.vagabondWeapons.map(w => `<option value="${w}">${w}</option>`).join('')}
            </select>
            <button class="btn-small" onclick="document.getElementById('vagabond-weapon').value=pick(TABLES.vagabondWeapons)">üé≤</button>
            <label>Enhancement (Effect or Element):</label>
            <select id="vagabond-enhance">
                ${[...TABLES.physicalEffects, ...TABLES.etherealEffects, ...TABLES.physicalElements, ...TABLES.etherealElements].map(e => `<option value="${e}">${e}</option>`).join('')}
            </select>
            <button class="btn-small" onclick="randomEnhancement()">üé≤</button>
            <label>Path:</label>
            <select id="vagabond-path">
                ${TABLES.paths.map(p => `<option value="${p}">${p}</option>`).join('')}
            </select>
            <button class="btn-small" onclick="document.getElementById('vagabond-path').value=pick(TABLES.paths)">üé≤</button>
        `;
    }
}

function randomQuintessence() {
    const all = [...TABLES.physicalElements, ...TABLES.etherealElements, ...TABLES.physicalForms, ...TABLES.etherealForms];
    document.getElementById('mage-quint').value = pick(all);
}

function randomEnhancement() {
    const all = [...TABLES.physicalEffects, ...TABLES.etherealEffects, ...TABLES.physicalElements, ...TABLES.etherealElements];
    document.getElementById('vagabond-enhance').value = pick(all);
}

function randomWeaponPackage() {
    document.getElementById('create-weapons').value = Math.floor(Math.random() * TABLES.weaponPackages.length);
}

function randomTools() {
    document.getElementById('create-tool1').value = pick(TABLES.tools);
    document.getElementById('create-tool2').value = pick(TABLES.tools);
}

function randomItems() {
    document.getElementById('create-item1').value = pick(TABLES.items);
    document.getElementById('create-item2').value = pick(TABLES.items);
}

function randomGoal() {
    document.getElementById('create-goal').value = pick(TABLES.goals);
}

function randomRelationship() {
    document.getElementById('create-relationship').value = pick(TABLES.relationships);
}

function randomBackground() {
    const bg = pick(TABLES.backgrounds);
    document.getElementById('create-background').value = bg.name;
}

function createCharacter() {
    const name = document.getElementById('char-name').value.trim();
    if (!name) {
        newAlert('Please enter a character name!');
        return;
    }
    
    const str = parseInt(document.getElementById('create-str').value) || 0;
    const dex = parseInt(document.getElementById('create-dex').value) || 0;
    const wil = parseInt(document.getElementById('create-wil').value) || 0;
    const archetype = document.getElementById('create-archetype').value;
    
    const weaponPkg = TABLES.weaponPackages[parseInt(document.getElementById('create-weapons').value)];
    const tool1 = document.getElementById('create-tool1').value;
    const tool2 = document.getElementById('create-tool2').value;
    const item1 = document.getElementById('create-item1').value;
    const item2 = document.getElementById('create-item2').value;
    const goal = document.getElementById('create-goal').value;
    const relationship = document.getElementById('create-relationship').value;
    const background = document.getElementById('create-background').value;
    
    character = {
        name: name,
        level: 1,
        xp: 0,
        str: str,
        dex: dex,
        wil: wil,
        maxHealth: 6 + str,
        currentHealth: 6 + str,
        armor: weaponPkg.armor,
        archetype: archetype,
        features: [],
        weapons: [...weaponPkg.items],
        items: [
            { name: tool1, location: 'backpack' },
            { name: tool2, location: 'backpack' },
            { name: item1, location: 'backpack' },
            { name: item2, location: 'backpack' }
        ],
        goal: goal,
        relationship: relationship,
        background: background,
        spells: [],
        essence: 0,
        maxEssence: 2,
        prayers: 0,
        maxPrayers: 3,
        quintessence: [],
        implement: '',
        domain: '',
        signatureWeapon: '',
        signatureEnhancements: [],
        path: '',
        scars: [],
        attackBonus: 0,
        paths: [],
        miracles: [],
        customMiracles: [],
        featureFlags: {
            augment: false,
            recall: false,
            extract: false,
            shape: false,
            experiment: false,
            craft: false,
            permeable: false,
            quickened: false,
            dazzle: false,
            beacon: false,
            smite: false,
            ward: false,
            enhance: false,
            reflexes: false,
            riposte: false,
            fortitude: false,
            skirmish: false
        },
        experimentSpell: null,
        keptSpells: [],
        tempHealth: 0
    };
    
    // Add archetype-specific stuff
    if (archetype === 'mage') {
        character.implement = document.getElementById('mage-implement')?.value || pick(TABLES.implements);
        character.quintessence = [document.getElementById('mage-quint')?.value || pick(TABLES.physicalElements)];
        character.essence = 2;
        character.maxEssence = 2;
        character.features.push(`Implement: ${character.implement}`);
        character.features.push(`Quintessence: ${character.quintessence.join(', ')}`);
        character.spells = [generateRandomSpell(), generateRandomSpell()];
    } else if (archetype === 'disciple') {
        character.domain = document.getElementById('disciple-domain')?.value || pick(TABLES.domains);
        character.prayers = 3;
        character.maxPrayers = 3;
        character.miracles = ['Protection', 'Light', 'Purify', 'Dominion'];
        character.features.push(`Favored Domain: ${character.domain}`);
        character.features.push('Miracles: Protection, Light, Purify, Dominion');
    } else if (archetype === 'vagabond') {
        character.signatureWeapon = document.getElementById('vagabond-weapon')?.value || pick(TABLES.vagabondWeapons);
        character.signatureEnhancements = [document.getElementById('vagabond-enhance')?.value || pick(TABLES.physicalEffects)];
        character.path = document.getElementById('vagabond-path')?.value || pick(TABLES.paths);
        character.paths = [];
        character.features.push(`Signature Weapon: ${character.signatureWeapon} (${character.signatureEnhancements.join(', ')})`);
        character.features.push(`Path: ${character.path}`);
    }
    
    // Add background items
    const bgData = TABLES.backgrounds.find(b => b.name === background);
    if (bgData) {
        bgData.items.forEach(item => {
            character.items.push({ name: item, location: 'backpack' });
        });
    }
    
    updateDisplay();
    saveCharacter();
    showTab('character');
    newAlert('Character created successfully!');
}

// ============ SPELLS ============
function generateOldRandomSpell() {
    const effect = pick([...TABLES.physicalEffects, ...TABLES.etherealEffects]);
    const element = pick([...TABLES.physicalElements, ...TABLES.etherealElements]);
    const form = pick([...TABLES.physicalForms, ...TABLES.etherealForms]);
    
    const name = `${effect} ${element} ${form}`;
    const desc = `A spell combining ${effect.toLowerCase()} energy with ${element.toLowerCase()} in the shape of a ${form.toLowerCase()}.`;
    
    const spell = { name, desc };
    
    // If Augment is active, add an effect
    if (character.featureFlags?.augment) {
        spell.effect = pick([...TABLES.physicalEffects, ...TABLES.etherealEffects]);
    }
    
    return spell;
}

function generateSpell() {
    const spell = generateOldRandomSpell();
    const resultDiv = document.getElementById('generated-spell');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <h4>${spell.name}</h4>
        <p>${spell.desc}</p>
        ${spell.effect ? `<p><strong>Augmented Effect:</strong> ${spell.effect}</p>` : ''}
        <button onclick="addSpellToCharacter('${spell.name}', '${spell.desc}', '${spell.effect || ''}')">Add to Memorized Spells</button>
    `;
}

function generateRandomSpell() {
    const d1 = Math.ceil(roll(6) / 2);
    const d2 = roll(6);
    const d3 = roll(6);
    const code = d1 * 100 + d2 * 10 + d3;
    
    let spell = TABLES.spells[code];
    return spell;
}

function generateSpellFromTable() {
    const d1 = Math.ceil(roll(6) / 2);
    const d2 = roll(6);
    const d3 = roll(6);
    const code = d1 * 100 + d2 * 10 + d3;
    
    let spell = TABLES.spells[code];
    if (!spell) {
        spell = { name: `Unknown Spell (${code})`, desc: "A mysterious spell lost to time." };
    }
    
    const resultDiv = document.getElementById('generated-spell');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <h4>${spell.name}</h4>
        <p>Rolled: ${d1}-${d2}-${d3} = ${code}</p>
        <p>${spell.desc}</p>
        <button onclick="addSpellToCharacter('${spell.name}', \`${spell.desc}\`)">Add to Memorized Spells</button>
    `;
}

function addSpellToCharacter(name, desc, effect = '') {
    const spell = { name, desc };
    if (effect) spell.effect = effect;
    character.spells.push(spell);
    updateDisplay();
    saveCharacter();
    newAlert('Spell added!');
}

function castSpell(index) {
    if (character.essence <= 0) {
        newAlert('No essence remaining! Conduct a ritual to restore.');
        return;
    }
    
    const spell = character.spells[index];
    character.essence--;
    
    let castMessage = `Cast spell: ${spell.name}`;
    if (character.quintessence.length > 0) {
        castMessage += ` (May enhance with: ${character.quintessence.join(', ')})`;
    }
    if (spell.effect) {
        castMessage += ` [Augmented: ${spell.effect}]`;
    }
    
    logCombat(castMessage);
    updateDisplay();
    saveCharacter();
}

function modifyEssence(amount) {
    character.essence = Math.max(0, Math.min(character.maxEssence, character.essence + amount));
    updateDisplay();
    saveCharacter();
}

function rollComponent(type) {
    let result = '';
    if (type === 'effect') {
        result = pick([...TABLES.physicalEffects, ...TABLES.etherealEffects]);
    } else if (type === 'element') {
        result = pick([...TABLES.physicalElements, ...TABLES.etherealElements]);
    } else if (type === 'form') {
        result = pick([...TABLES.physicalForms, ...TABLES.etherealForms]);
    }
    
    const resultDiv = document.getElementById('component-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `<div class="dice">${type.toUpperCase()}</div><div class="total">${result}</div>`;
}

// ============ COMBAT ============
function rollAttack() {
    const weaponAB = parseInt(document.getElementById('weapon-type').value) + character.attackBonus;
    const targetArmor = parseInt(document.getElementById('target-armor').value);
    const hasAdvantage = document.getElementById('has-advantage').checked;
    
    let dice = hasAdvantage ? rollMultiple(3, 6) : rollMultiple(2, 6);
    let kept = hasAdvantage ? dice.sort((a,b) => b-a).slice(0, 2) : dice;
    let diceTotal = kept.reduce((a, b) => a + b, 0);
    let total = diceTotal + weaponAB;
    
    let hit = total > targetArmor;
    let damage = hit ? total - targetArmor : 0;
    
    const resultDiv = document.getElementById('attack-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="dice">[${dice.join('] [')}]${hasAdvantage ? ' (kept ' + kept.join(', ') + ')' : ''}</div>
        <div class="total">${diceTotal} + ${weaponAB} AB = <strong>${total}</strong> vs Armor ${targetArmor}</div>
        <div class="${hit ? 'success' : 'failure'}" style="font-size:24px; margin-top:10px;">
            ${hit ? `HIT! ${damage} damage` : 'MISS!'}
        </div>
    `;
    
    logCombat(`Attack: ${dice.join('+')}${hasAdvantage ? '(adv)' : ''} + ${weaponAB} = ${total} vs ${targetArmor} ‚Üí ${hit ? damage + ' damage' : 'miss'}`);
}

function calculateDamage() {
    const incoming = parseInt(document.getElementById('incoming-attack').value);
    const armor = character.armor;
    
    let damage = Math.max(0, incoming - armor);
    
    const resultDiv = document.getElementById('damage-result');
    resultDiv.style.display = 'block';
    
    if (damage > 0) {
        // Check for temp health first
        if (character.tempHealth > 0) {
            if (character.tempHealth >= damage) {
                character.tempHealth -= damage;
                resultDiv.innerHTML = `
                    <div class="success" style="font-size:24px;">
                        Absorbed ${damage} damage with temporary HP!
                    </div>
                    <div>Temp HP remaining: ${character.tempHealth}</div>
                `;
                logCombat(`Absorbed ${damage} damage with temp HP. Temp HP: ${character.tempHealth}`);
                updateDisplay();
                saveCharacter();
                return;
            } else {
                const absorbed = character.tempHealth;
                damage -= character.tempHealth;
                character.tempHealth = 0;
                resultDiv.innerHTML += `<div>Temp HP absorbed ${absorbed} damage.</div>`;
            }
        }
        
        character.currentHealth -= damage;
        resultDiv.innerHTML = `
            <div class="failure" style="font-size:24px;">
                ${incoming} - ${armor} armor = <strong>${damage} damage taken!</strong>
            </div>
            <div>Current Health: ${character.currentHealth}/${character.maxHealth}</div>
        `;
        
        // Check for Riposte
        if (character.featureFlags.riposte) {
            resultDiv.innerHTML += `<div class="riposte-prompt"><button onclick="useRiposte()">‚öîÔ∏è Use Riposte!</button></div>`;
        }
        
        if (character.currentHealth <= 0) {
            resultDiv.innerHTML += `<div class="failure" style="margin-top:10px;">‚ö†Ô∏è AT ‚â§0 HP - Do a dying roll!!</div>`;
        }
        logCombat(`Took ${damage} damage (${incoming} - ${armor} armor). HP: ${character.currentHealth}/${character.maxHealth}`);
    } else {
        resultDiv.innerHTML = `
            <div class="success" style="font-size:24px;">
                Attack blocked! (${incoming} vs ${armor} armor)
            </div>
        `;
        logCombat(`Blocked attack (${incoming} vs ${armor} armor)`);
    }
    
    updateDisplay();
    saveCharacter();
}

function useRiposte() {
    logCombat('‚öîÔ∏è RIPOSTE! Making immediate counter-attack!');
    newAlert('Riposte activated! Make your counter-attack now.');
}

function rollInitiative() {
    // Check for Reflexes feature
    if (character.featureFlags.reflexes) {
        const resultDiv = document.getElementById('initiative-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="success" style="font-size:24px;">
                <strong>REFLEXES:</strong> You always go first!
            </div>
        `;
        logCombat('Initiative: Reflexes feature - Always first!');
        return;
    }
    
    const dice = rollMultiple(2, 6);
    const total = dice.reduce((a, b) => a + b, 0) + character.dex;
    const success = total >= 10;
    
    const resultDiv = document.getElementById('initiative-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="dice">[${dice.join('] [')}]</div>
        <div class="total">${dice.reduce((a,b)=>a+b,0)} + ${character.dex} DEX = <strong>${total}</strong></div>
        <div class="${success ? 'success' : 'failure'}" style="font-size:24px; margin-top:10px;">
            ${success ? 'Go First!' : 'Go After Enemies'}
        </div>
    `;
    
    logCombat(`Initiative: ${total} ‚Üí ${success ? 'Go first' : 'Go after enemies'}`);
}
/*
function rollScar() {
    // Check for Fortitude feature
    let dice, result;
    if (character.featureFlags.fortitude) {
        dice = rollMultiple(3, 6);
        // Player chooses, for now we'll just show them all
        const resultDiv = document.getElementById('scar-result');
        resultDiv.style.display = 'block';
        resultDiv.innerHTML = `
            <div class="dice">[${dice.join('] [')}] (Fortitude: choose 2)</div>
            <p>Select which dice to keep:</p>
            ${dice.map((d, i) => `<button onclick="applyScarResult([${dice.filter((_, j) => j !== i).join(',')}])">${dice.filter((_, j) => j !== i).join(' + ')}</button>`).join(' ')}
        `;
        return;
    }
    
    result = roll(6);
    applyScarResult([result]);
}

function applyScarResult(diceKept) {
    const total = diceKept.reduce((a, b) => a + b, 0);
    const result = Math.min(6, Math.max(1, Math.floor(total / diceKept.length))); // Average for display
    const scar = TABLES.scars[result - 1];
    
    character.scars.push(scar);
    
    // Apply scar effects
    if (result === 2) {
        const abilities = ['str', 'dex', 'wil'];
        const reduced = pick(abilities);
        character[reduced]--;
        alert(`Broken! ${reduced.toUpperCase()} reduced by 1.`);
    } else if (result === 3) {
        character.maxHealth--;
        alert('Maimed! Max Health reduced by 1.');
    } else if (result === 5) {
        const mutation = pick(TABLES.mutations);
        character.scars.push(`Mutation: ${mutation}`);
    } else if (result === 6) {
        const insanity = pick(TABLES.insanities);
        character.scars.push(`Insanity: ${insanity}`);
    }
    
    const resultDiv = document.getElementById('scar-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="dice">[${diceKept.join('] [')}]</div>
        <div class="failure" style="font-size:18px; margin-top:10px;">${scar}</div>
    `;
    
    updateDisplay();
    saveCharacter();
    logCombat(`Scar rolled: ${scar}`);
}
*/

function rollScar() {
    let excessDamage = character.currentHealth > 0 ? 0 : Math.abs(character.currentHealth);
    const resultDiv = document.getElementById('scar-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = '';

    // 1. Fortitude Feature: Roll 3d, choose 2
    if (character.featureFlags.fortitude) {
        // Roll 3 separate dice
        const d1 = roll(6);
        const d2 = roll(6);
        const d3 = roll(6);
        const dice = [d1, d2, d3];

        // Pre-calculate pairs for the buttons
        // Option 1: Keep d1 + d2
        // Option 2: Keep d1 + d3
        // Option 3: Keep d2 + d3
        const options = [
            { kept: [d1, d2], sum: d1 + d2 + excessDamage },
            { kept: [d1, d3], sum: d1 + d3 + excessDamage },
            { kept: [d2, d3], sum: d2 + d3 + excessDamage }
        ];

        resultDiv.innerHTML = `
            <div class="dice-display">
                Rolled: [${d1}] [${d2}] [${d3}] (Fortitude)
                ${excessDamage > 0 ? `<br>Excess Damage: +${excessDamage}` : ''}
            </div>
            <p><strong>Fortitude:</strong> Select which dice to keep:</p>
            <div class="button-group">
                ${options.map(opt => `
                    <button onclick="applyScarResult([${opt.kept.join(',')}], ${excessDamage})">
                        Keep [${opt.kept.join(' + ')}] 
                        ${excessDamage > 0 ? `+ ${excessDamage}` : ''}
                        = <strong>${opt.sum}</strong>
                    </button>
                `).join('')}
            </div>
        `;
        return;
    }

    // 2. Standard Rule: Roll 2d
    const result = [roll(6), roll(6)];
    
    // Show initial roll immediately
    resultDiv.innerHTML = `
        <div class="dice-display">
            Rolled: [${result.join('] [')}]
            ${excessDamage > 0 ? ` + Excess Damage: ${excessDamage}` : ''}
        </div>
    `;

    applyScarResult(result, excessDamage);
}

function applyScarResult(keptDice, excessDamage) {
    const resultDiv = document.getElementById('scar-result');
    
    // Calculate Total
    const diceSum = keptDice.reduce((a, b) => a + b, 0);
    const total = diceSum + excessDamage;

    let html = `<div class="final-result" style="margin-top: 10px; border-top: 1px solid #ccc; padding-top: 10px;">`;
    
    html += `<h3>Total: ${total}</h3>`;

    if (total >= 10) {
        // --- DEAD ---
        html += `
            <div class="outcome dead" style="color: red;">
                <strong>RESULT: 10+ (DEAD)</strong>
                <p>You are dead. Roll a new character.</p>
            </div>`;
    } 
    else if (total >= 7) {
        // --- UNCONSCIOUS ---
        html += `
            <div class="outcome unconscious" style="color: darkorange;">
                <strong>RESULT: 7-9 (UNCONSCIOUS)</strong>
                <p>You are unconscious and bleeding out.</p>
                <p><em>At the end of your sides‚Äô turn, roll 1d. When you roll a 6, you are dead.</em></p>
            </div>`;
    } 
    else {
        // --- SCAR (6 or less) ---
        // Roll the specific scar
        const scarDie = roll(6);
        
        let scar = TABLES.scars[scarDie - 1];
    
        // Apply scar effects
        if (scarDie === 2) {
            const abilities = ['str', 'dex', 'wil'];
            const reduced = pick(abilities);
            character[reduced]--;
        } else if (scarDie === 3) {
            character.maxHealth--;
        } else if (scarDie === 5) {
            const mutation = pick(TABLES.mutations);
            scar = `Twisted: Mutation: ${mutation}`;
        } else if (scarDie === 6) {
            const insanity = pick(TABLES.insanities);
            scar = `Splintered: Insanity: ${insanity}`;
        }

        logCombat(`Scar rolled: ${scar}`);
        character.scars.push(scar);
        character.currentHealth = 1;
        html += `
            <div class="outcome scar" style="color: yellow;">
                <strong>RESULT: 1-6 (SCAR)</strong>
                <p>Your current Health is set to <strong>1</strong>.</p>
                <div class="scar-roll" style="padding: 5px; border-radius: 4px;">
                    <span>Scar Roll Result: ${scarDie}</span><br>
                    NEW SCAR! ${scar}
                </div>
            </div>`;
    }

    resultDiv.innerHTML = html;

    updateDisplay();
    saveCharacter();
}

function logCombat(message) {
    const timestamp = new Date().toLocaleTimeString();
    combatLog.unshift(`[${timestamp}] ${message}`);
    if (combatLog.length > 50) combatLog.pop();
    
    document.getElementById('combat-log').innerHTML = combatLog.map(l => `<div class="log-entry">${l}</div>`).join('');
}

function clearCombatLog() {
    combatLog = [];
    document.getElementById('combat-log').innerHTML = '';
}

// ============ DICE ROLLER ============
function quickRoll(count, sides) {
    const dice = rollMultiple(count, sides);
    const total = dice.reduce((a, b) => a + b, 0);
    
    addToRollHistory(`${count}d${sides}: [${dice.join('] [')}] = ${total}`);
}

function rollDanger() {
    const ability = document.getElementById('danger-ability').value;
    const hasAdvantage = document.getElementById('danger-advantage').checked;
    const abilityValue = character[ability];
    
    // Check for Beacon bonus
    let bonusFromBeacon = 0;
    if (character.featureFlags.beacon) {
        // Would need to track if Light is active on wielded object
        // For now, add a checkbox or assume it could apply
    }
    
    let dice = hasAdvantage ? rollMultiple(3, 6) : rollMultiple(2, 6);
    let kept = hasAdvantage ? dice.sort((a,b) => b-a).slice(0, 2) : dice;
    let diceTotal = kept.reduce((a, b) => a + b, 0);
    let total = diceTotal + abilityValue + bonusFromBeacon;
    let success = total >= 10;
    
    const resultDiv = document.getElementById('danger-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="dice">[${dice.join('] [')}]${hasAdvantage ? ' (kept ' + kept.join(', ') + ')' : ''}</div>
        <div class="total">${diceTotal} + ${abilityValue} ${ability.toUpperCase()} = <strong>${total}</strong></div>
        <div class="${success ? 'success' : 'failure'}" style="font-size:24px; margin-top:10px;">
            ${success ? 'SUCCESS!' : 'FAILURE!'}
        </div>
    `;
    
    addToRollHistory(`Danger (${ability.toUpperCase()}): ${total} ‚Üí ${success ? 'Success' : 'Failure'}`);
}

function rollOpposed() {
    const yourBonus = parseInt(document.getElementById('opposed-your-bonus').value) || 0;
    const oppBonus = parseInt(document.getElementById('opposed-opp-bonus').value) || 0;
    
    const yourDice = rollMultiple(2, 6);
    const oppDice = rollMultiple(2, 6);
    const yourTotal = yourDice.reduce((a,b) => a+b, 0) + yourBonus;
    const oppTotal = oppDice.reduce((a,b) => a+b, 0) + oppBonus;
    
    const youWin = yourTotal > oppTotal;
    
    const resultDiv = document.getElementById('opposed-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div>You: [${yourDice.join('] [')}] + ${yourBonus} = <strong>${yourTotal}</strong></div>
        <div>Opponent: [${oppDice.join('] [')}] + ${oppBonus} = <strong>${oppTotal}</strong></div>
        <div class="${youWin ? 'success' : 'failure'}" style="font-size:24px; margin-top:10px;">
            ${youWin ? 'You Win!' : 'Opponent Wins!'}
        </div>
    `;
    
    addToRollHistory(`Opposed: ${yourTotal} vs ${oppTotal} ‚Üí ${youWin ? 'You win' : 'Opponent wins'}`);
}

function rollBarter() {
    const quality = parseInt(document.getElementById('barter-quality').value) || 0;
    const dice = rollMultiple(2, 6);
    const total = dice.reduce((a,b) => a+b, 0) + character.wil;
    const success = total >= 10;
    const resultQuality = success ? quality : Math.max(0, quality - 1);
    
    const resultDiv = document.getElementById('barter-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="dice">[${dice.join('] [')}]</div>
        <div class="total">${dice.reduce((a,b) => a+b, 0)} + ${character.wil} WIL = <strong>${total}</strong></div>
        <div class="${success ? 'success' : 'failure'}" style="font-size:24px; margin-top:10px;">
            ${success ? `Equal Trade! (Quality ${resultQuality})` : `Lower Quality Trade (Quality ${resultQuality})`}
        </div>
    `;
    
    addToRollHistory(`Barter: ${total} ‚Üí Quality ${resultQuality} item`);
}

function addToRollHistory(message) {
    rollHistory.unshift(message);
    if (rollHistory.length > 20) rollHistory.pop();
    document.getElementById('roll-history').innerHTML = rollHistory.map(r => `<div class="item"><span>${r}</span></div>`).join('');
}

function clearRollHistory() {
    rollHistory = [];
    document.getElementById('roll-history').innerHTML = '';
}

// ============ EXPLORATION ============
function rollHazard() {
    const result = roll(6);
    const hazard = TABLES.hazards[result - 1];
    
    const resultDiv = document.getElementById('hazard-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="dice">[${result}]</div>
        <div style="font-size:20px; margin-top:10px;"><strong>${hazard.name}</strong></div>
        <div>${hazard.desc}</div>
    `;
}

function rollMorale() {
    const npcWil = parseInt(document.getElementById('morale-wil').value) || 0;
    const dice = rollMultiple(2, 6);
    const total = dice.reduce((a,b) => a+b, 0) + npcWil;
    const success = total >= 10;
    
    const resultDiv = document.getElementById('morale-result');
    resultDiv.style.display = 'block';
    resultDiv.innerHTML = `
        <div class="dice">[${dice.join('] [')}]</div>
        <div class="total">${dice.reduce((a,b) => a+b, 0)} + ${npcWil} WIL = <strong>${total}</strong></div>
        <div class="${success ? 'success' : 'failure'}" style="font-size:24px; margin-top:10px;">
            ${success ? 'NPC Holds!' : 'NPC Routs/Begs for Mercy!'}
        </div>
    `;
}

function awardSessionXP() {
    const checks = document.querySelectorAll('.xp-check:checked');
    const xp = checks.length;
    if (xp > 0) {
        addXP(xp);
        newAlert(`Awarded ${xp} XP!`);
        checks.forEach(c => c.checked = false);
    } else {
        newAlert('No XP to award - check the boxes for "yes" answers first!');
    }
}

// ============ PATH ADVANTAGE CHECK ============
function checkPathAdvantage(situation) {
    const allPaths = [character.path, ...character.paths].filter(p => p);
    const pathKeywords = {
        'Briarborn': ['tracking', 'foraging', 'survival', 'wilderness', 'nature', 'forest', 'hunt', 'animal'],
        'Fingersmith': ['tinkering', 'crafting', 'picking', 'locks', 'pockets', 'mechanism', 'device', 'trap'],
        'Roofrunner': ['climbing', 'leaping', 'balancing', 'scaling', 'crawling', 'jump', 'acrobat', 'height'],
        'Shadowjack': ['silent', 'hiding', 'shadows', 'sneaking', 'stealth', 'unseen', 'quiet'],
        'Truthweaver': ['convincing', 'commanding', 'manipulating', 'demanding', 'persuade', 'lie', 'charm', 'intimidate']
    };
    
    const situationLower = situation.toLowerCase();
    
    for (const path of allPaths) {
        const keywords = pathKeywords[path] || [];
        if (keywords.some(kw => situationLower.includes(kw))) {
            return { applies: true, path: path };
        }
    }
    
    return { applies: false };
}

// ============ SAVE/LOAD ============
function saveCharacter() {
    localStorage.setItem('islandRatsCharacter', JSON.stringify(character));
}

function loadCharacter() {
    const saved = localStorage.getItem('islandRatsCharacter');
    if (saved) {
        const loadedChar = JSON.parse(saved);
        // Merge with default to ensure all new properties exist
        character = {
            ...character,
            ...loadedChar,
            featureFlags: {
                ...character.featureFlags,
                ...(loadedChar.featureFlags || {})
            }
        };
        updateDisplay();
    }
}

function deleteCharacter() {
    if (confirm('Are you sure you want to delete this character? This cannot be undone!')) {
        localStorage.removeItem('islandRatsCharacter');
        character = {
            name: "", level: 1, xp: 0, str: 0, dex: 0, wil: 0,
            maxHealth: 6, currentHealth: 6, armor: 6, archetype: "",
            features: [], weapons: [], items: [], goal: "",
            relationship: "", background: "", spells: [],
            essence: 0, maxEssence: 2, prayers: 0, maxPrayers: 3,
            quintessence: [], implement: "", domain: "",
            signatureWeapon: "", signatureEnhancements: [],
            path: "", scars: [],
            attackBonus: 0, paths: [], miracles: [], customMiracles: [],
            featureFlags: {
                augment: false, recall: false, extract: false,
                shape: false, experiment: false, craft: false,
                permeable: false, quickened: false, dazzle: false,
                beacon: false, smite: false, ward: false,
                enhance: false, reflexes: false, riposte: false,
                fortitude: false, skirmish: false
            },
            experimentSpell: null, keptSpells: [], tempHealth: 0
        };
        updateDisplay();
        newAlert('Character deleted.');
    }
}

function exportCharacter() {
    const data = JSON.stringify(character, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${character.name || 'character'}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function populateDropdown(selectId, dataArray, valueProperty = 'name') {
    const select = document.getElementById(selectId);
    if (!select) {
        console.error(`Select element with id "${selectId}" not found`);
        return;
    }

    select.innerHTML = '';

    dataArray.forEach((item, index) => {
        const option = document.createElement('option');
        option.value = valueProperty ? item[valueProperty] : index;
        option.textContent = item.name;
        select.appendChild(option);
    });
}

// ============ INITIALIZATION ============
loadCharacter();
updateDisplay();

function initDropdowns() {
    populateSelect('create-tool1', TABLES.tools);
    populateSelect('create-tool2', TABLES.tools);
    populateSelect('create-item1', TABLES.items);
    populateSelect('create-item2', TABLES.items);
    populateDropdown('create-weapons', TABLES.weaponPackages, false);
    populateSelect('create-goal', TABLES.goals);
    populateSelect('create-relationship', TABLES.relationships);
    populateDropdown('create-background', TABLES.backgrounds);
    const hash = window.location.href.split('#')[1];
    if (hash === undefined) {
        showTab('character');
    } else {
        showTab(hash);
    }
}

document.addEventListener('DOMContentLoaded', initDropdowns);
    </script>
</body>
</html>

